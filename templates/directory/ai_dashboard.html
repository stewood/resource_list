{% extends "base.html" %}
{% load static %}

{% block title %}AI Review Dashboard - {{ resource.name }}{% endblock %}

{% block extra_css %}
<style>
    /* AI Dashboard Specific Styles - Override base theme */
    .ai-dashboard {
        max-width: 1400px !important;
        margin: 0 auto !important;
        padding: 20px !important;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
        background: #ffffff !important;
        color: #1f2937 !important;
        min-height: 100vh !important;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 40px !important;
        border-radius: 16px !important;
        margin-bottom: 30px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1) !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: -1;
    }
    
    .resource-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .ai-status {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        font-size: 1.1rem;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-ready { background-color: #10b981; }
    .status-running { background-color: #f59e0b; }
    .status-complete { background-color: #3b82f6; }
    .status-error { background-color: #ef4444; }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white !important;
        padding: 24px !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        border: 1px solid #e5e7eb !important;
        text-align: center !important;
        transition: transform 0.2s, box-shadow 0.2s !important;
        color: #1f2937 !important;
    }
    
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .summary-card h3 {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }
    
    .summary-card .number {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .summary-card .label {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .changes-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    
    .category-section {
        border-bottom: 1px solid #f3f4f6;
    }
    
    .category-header {
        background: #f9fafb;
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .category-header:hover {
        background: #f3f4f6;
    }
    
    .category-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .category-summary {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .category-content {
        padding: 0;
    }
    
    .change-item {
        padding: 24px;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .change-item:hover {
        background: #f9fafb;
    }
    
    .change-item:last-child {
        border-bottom: none;
    }
    
    .change-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .change-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        flex: 1;
    }
    
    .confidence-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .confidence-high {
        background: #dcfce7;
        color: #166534;
    }
    
    .confidence-medium {
        background: #fef3c7;
        color: #92400e;
    }
    
    .confidence-low {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .change-comparison {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 16px;
        align-items: center;
        margin-bottom: 16px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
    }
    
    .current-value, .suggested-value {
        padding: 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        line-height: 1.5;
    }
    
    .current-value {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    .suggested-value {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .arrow {
        font-size: 1.5rem;
        color: #6b7280;
        font-weight: bold;
    }
    
    .reasoning-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .reasoning-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .reasoning-content {
        color: #374151;
        font-size: 0.875rem;
        line-height: 1.6;
    }
    
    .enhanced-description-section {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
    }
    
    .enhanced-title {
        font-weight: 600;
        color: #0c4a6e;
        margin-bottom: 8px;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .enhanced-content {
        color: #0c4a6e;
        font-size: 0.875rem;
        line-height: 1.6;
        margin-bottom: 12px;
        background: white;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e0f2fe;
    }
    
    .btn-use-enhanced {
        background: #0ea5e9;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-use-enhanced:hover {
        background: #0284c7;
    }
    
    .source-link {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 500;
    }
    
    .source-link:hover {
        text-decoration: underline;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-approve, .btn-reject {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-approve {
        background: #10b981;
        color: white;
    }
    
    .btn-approve:hover {
        background: #059669;
    }
    
    .btn-approve.approved {
        background: #059669;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Markdown Report Styles */
    .markdown-report-container {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    /* Simple Markdown Report Styles */
    .markdown-report-simple {
        background: white;
        border: 2px solid #3b82f6;
        border-radius: 12px;
        margin: 20px 0;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .markdown-report-simple h3 {
        color: #1f2937;
        margin-bottom: 15px;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .markdown-content-simple {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 500px;
        overflow-y: auto;
    }

    .report-header {
        background: #f8fafc;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .report-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .btn-toggle-report {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-toggle-report:hover {
        background: #2563eb;
    }

    .report-content {
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
    }

    .markdown-content {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.6;
        color: #1f2937;
    }

    .markdown-content h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 1rem 0;
        color: #111827;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }

    .markdown-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 1.5rem 0 1rem 0;
        color: #111827;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.25rem;
    }

    .markdown-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1.25rem 0 0.75rem 0;
        color: #111827;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.875rem;
    }

    .markdown-content th,
    .markdown-content td {
        border: 1px solid #e5e7eb;
        padding: 8px 12px;
        text-align: left;
    }

    .markdown-content th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .markdown-content tr:nth-child(even) {
        background: #f9fafb;
    }

    .markdown-content ul,
    .markdown-content ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin: 0.25rem 0;
    }

    .markdown-content code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875em;
    }

    .markdown-content pre {
        background: #f3f4f6;
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
        margin: 1rem 0;
    }

    .markdown-content pre code {
        background: none;
        padding: 0;
    }

    .markdown-content blockquote {
        border-left: 4px solid #3b82f6;
        margin: 1rem 0;
        padding-left: 1rem;
        color: #6b7280;
        font-style: italic;
    }
    
    .btn-reject {
        background: #ef4444;
        color: white;
    }
    
    .btn-reject:hover {
        background: #dc2626;
    }
    
    .btn-reject.rejected {
        background: #dc2626;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .action-panel {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        padding: 24px;
        margin-top: 30px;
    }
    
    .action-panel h3 {
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 12px;
    }
    
    .action-panel p {
        color: #6b7280;
        margin-bottom: 20px;
        line-height: 1.6;
    }
    
    .action-buttons-large {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn-primary, .btn-secondary, .btn-outline {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .btn-outline {
        background: transparent;
        color: #6b7280;
        border: 1px solid #d1d5db;
    }
    
    .btn-outline:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .initial-panel {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        padding: 40px;
        text-align: center;
    }
    
    .initial-panel h3 {
        color: #1f2937;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 16px;
    }
    
    .initial-panel p {
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.6;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .run-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 32px;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 12px;
    }
    
    .run-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .run-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-changes {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .no-changes h3 {
        color: #1f2937;
        margin-bottom: 12px;
    }
    
    /* Override main container background for AI dashboard */
    main.container {
        background: transparent !important;
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Force light theme for AI dashboard */
    body {
        background-color: #ffffff !important;
        color: #1f2937 !important;
    }
    
    /* Override any dark theme variables for AI dashboard */
    .ai-dashboard,
    .ai-dashboard * {
        --isaiah-bg-primary: #ffffff !important;
        --isaiah-bg-secondary: #f8f9fa !important;
        --isaiah-bg-tertiary: #ecf0f1 !important;
        --isaiah-text-primary: #1f2937 !important;
        --isaiah-text-secondary: #6b7280 !important;
        --isaiah-text-muted: #9ca3af !important;
        --isaiah-card-bg: #ffffff !important;
        --isaiah-card-border: #e5e7eb !important;
    }
    
    @media (max-width: 768px) {
        .ai-dashboard {
            padding: 16px !important;
        }
        
        .dashboard-header {
            padding: 24px;
        }
        
        .resource-title {
            font-size: 2rem;
        }
        
        .change-comparison {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .arrow {
            transform: rotate(90deg);
        }
        
        .action-buttons-large {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<form style="display: none;">
    {% csrf_token %}
</form>
<div class="ai-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="resource-title">{{ resource.name }}</div>
        <div class="ai-status">
            <div class="status-indicator status-ready" id="status-indicator"></div>
            <span id="status-text">Ready for AI Review</span>
        </div>
        <p>AI-powered resource verification and enhancement</p>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" id="summary-cards" style="display: none;">
        <div class="summary-card">
            <h3>Total Changes</h3>
            <div class="number" id="total-changes">0</div>
            <div class="label">suggested</div>
        </div>
        <div class="summary-card">
            <h3>High Confidence</h3>
            <div class="number" id="high-confidence">0</div>
            <div class="label">changes</div>
        </div>
        <div class="summary-card">
            <h3>Medium Confidence</h3>
            <div class="number" id="medium-confidence">0</div>
            <div class="label">changes</div>
        </div>
        <div class="summary-card">
            <h3>Low Confidence</h3>
            <div class="number" id="low-confidence">0</div>
            <div class="label">changes</div>
        </div>
    </div>

    <!-- Initial Panel -->
    <div class="initial-panel" id="initial-panel">
        <h3>Start AI Verification</h3>
        <p>Click the button below to run AI verification on this resource. The AI will analyze the current data and suggest improvements based on authoritative sources.</p>
        <button class="run-button" id="run-button">
            <span class="loading-spinner" id="loading-spinner"></span>
            <span>Run AI Verification</span>
        </button>
    </div>

    <!-- Changes Container -->
    <div class="changes-container" id="changes-container" style="display: none;"></div>

    <!-- Markdown Report Container -->
    <div class="markdown-report-container" id="markdown-report-container" style="display: none;">
        <div class="report-header">
            <h3>📋 Verification Report</h3>
        </div>
        <div class="report-content" id="report-content">
            <div class="markdown-content" id="markdown-content"></div>
        </div>
    </div>

    <!-- Action Panel -->
    <div class="action-panel" id="action-panel" style="display: none;">
        <h3>Apply Changes</h3>
        <p>Review the AI suggestions above and approve the changes you want to apply.</p>
        <div class="action-buttons-large">
            <button class="btn-primary" id="apply-button" disabled>Apply Approved Changes (0)</button>
            <button class="btn-outline" id="reset-button">Reset All</button>
            <button class="btn-secondary" id="run-again-button">Run Verification Again</button>
        </div>
    </div>
</div>

<script>
    // Get DOM elements
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const summaryCards = document.getElementById('summary-cards');
    const initialPanel = document.getElementById('initial-panel');
    const changesContainer = document.getElementById('changes-container');
    const actionPanel = document.getElementById('action-panel');
    const markdownReportContainer = document.getElementById('markdown-report-container');
    const reportContent = document.getElementById('report-content');
    const markdownContent = document.getElementById('markdown-content');
    
    // Debug DOM elements
    console.log('DOM elements found:');
    console.log('- markdownReportContainer:', markdownReportContainer);
    console.log('- reportContent:', reportContent);
    console.log('- markdownContent:', markdownContent);
    const runButton = document.getElementById('run-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const applyButton = document.getElementById('apply-button');
    const resetButton = document.getElementById('reset-button');
    const runAgainButton = document.getElementById('run-again-button');

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Track approved changes
    const approvedChanges = new Set();
    let aiData = null;

    // Update status
    function updateStatus(status, text) {
        statusText.textContent = text;
        statusIndicator.className = `status-indicator status-${status}`;
    }

    // Update summary
    function updateSummary(summary) {
        document.getElementById('total-changes').textContent = summary.total_changes;
        document.getElementById('high-confidence').textContent = summary.high_confidence;
        document.getElementById('medium-confidence').textContent = summary.medium_confidence;
        document.getElementById('low-confidence').textContent = summary.low_confidence;
        summaryCards.style.display = 'grid';
    }

    // Update apply button
    function updateApplyButton() {
        const count = approvedChanges.size;
        applyButton.textContent = `Apply Approved Changes (${count})`;
        applyButton.disabled = count === 0;
    }

    // Run AI verification
    runButton.addEventListener('click', async function() {
        updateStatus('running', 'Running AI Verification...');
        runButton.disabled = true;
        loadingSpinner.style.display = 'inline-block';
        
        try {
            const response = await fetch(`/api/resources/{{ resource.pk }}/ai-dashboard/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include'
            });
            
            const data = await response.json();
            console.log('API Response received:', data);
            console.log('Markdown report in response:', data.markdown_report ? 'YES' : 'NO');
            console.log('Markdown report length:', data.markdown_report ? data.markdown_report.length : 0);
            console.log('Markdown report preview:', data.markdown_report ? data.markdown_report.substring(0, 200) + '...' : 'NONE');
            
            if (data.status === 'success') {
                aiData = data.dashboard_data;
                updateStatus('complete', 'AI Verification Complete');
                updateSummary(data.summary);
                
                // Display Markdown report if available
                if (data.markdown_report && data.markdown_report.trim()) {
                    console.log('Markdown report found, length:', data.markdown_report.length);
                    console.log('Markdown report preview:', data.markdown_report.substring(0, 200) + '...');
                    displayMarkdownReport(data.markdown_report);
                } else {
                    console.log('No markdown report in response or report is empty');
                    console.log('Available data keys:', Object.keys(data));
                    // Generate a simple markdown report from the available data
                    const simpleReport = generateSimpleMarkdownReport(data, data.dashboard_data);
                    displayMarkdownReport(simpleReport);
                }
                
                if (aiData.total_changes > 0) {
                    displayChanges(aiData);
                    initialPanel.style.display = 'none';
                    actionPanel.style.display = 'block';
                } else {
                    displayNoChanges();
                }
            } else {
                updateStatus('error', 'AI Verification Failed');
                alert('Error: ' + data.message);
            }
        } catch (error) {
            updateStatus('error', 'Network Error');
            console.error('Error:', error);
            alert('Network error occurred. Please try again.');
        } finally {
            runButton.disabled = false;
            loadingSpinner.style.display = 'none';
        }
    });

    // Display changes
    function displayChanges(data) {
        changesContainer.innerHTML = '';
        
        Object.entries(data.category_summaries).forEach(([categoryKey, category]) => {
            const categoryChanges = data.changes.filter(change => change.category === categoryKey);
            const section = createCategorySection(category, categoryChanges);
            changesContainer.appendChild(section);
        });
        
        changesContainer.style.display = 'block';
    }

    // Create category section
    function createCategorySection(category, changes) {
        const section = document.createElement('div');
        section.className = 'category-section';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `
            <div class="category-title">${category.name}</div>
            <div class="category-summary">${changes.length} changes • High: ${category.high_count} • Medium: ${category.medium_count} • Low: ${category.low_count}</div>
        `;
        
        const content = document.createElement('div');
        content.className = 'category-content';
        
        changes.forEach(change => {
            const changeItem = createChangeItem(change);
            content.appendChild(changeItem);
        });
        
        section.appendChild(header);
        section.appendChild(content);
        return section;
    }

    // Create change item
    function createChangeItem(change) {
        const item = document.createElement('div');
        item.className = 'change-item';
        
        const confidenceClass = `confidence-${change.confidence}`;
        
        item.innerHTML = `
            <div class="change-header">
                <div class="change-title">${change.field_name}</div>
                <div class="confidence-badge ${confidenceClass}">${change.confidence}</div>
            </div>
            
            <div class="change-comparison">
                <div class="current-value">
                    <strong>Current:</strong><br>
                    ${change.current_value || 'Not specified'}
                </div>
                <div class="arrow">→</div>
                <div class="suggested-value">
                    <strong>Suggested:</strong><br>
                    ${change.suggested_value || 'Not specified'}
                </div>
            </div>
            
            <div class="reasoning-section">
                <div class="reasoning-title">AI Reasoning</div>
                <div class="reasoning-content">${change.reasoning}</div>
            </div>
            
            ${change.enhanced_description ? `
            <div class="enhanced-description-section">
                <div class="enhanced-title">Enhanced Description Suggestion</div>
                <div class="enhanced-content">${change.enhanced_description}</div>
                <button class="btn-use-enhanced" data-field="${change.field}">Use Enhanced Description</button>
            </div>
            ` : ''}
            
            <div class="action-buttons">
                <button class="btn-approve" data-field="${change.field}">Approve</button>
                <button class="btn-reject" data-field="${change.field}">Reject</button>
            </div>
        `;
        
        // Add event listeners
        const approveBtn = item.querySelector('.btn-approve');
        const rejectBtn = item.querySelector('.btn-reject');
        
        approveBtn.addEventListener('click', function() {
            if (approvedChanges.has(change.field)) {
                approvedChanges.delete(change.field);
                approveBtn.classList.remove('approved');
                rejectBtn.classList.remove('rejected');
            } else {
                approvedChanges.add(change.field);
                approveBtn.classList.add('approved');
                rejectBtn.classList.remove('rejected');
            }
            updateApplyButton();
        });
        
        rejectBtn.addEventListener('click', function() {
            approvedChanges.delete(change.field);
            approveBtn.classList.remove('approved');
            rejectBtn.classList.add('rejected');
            updateApplyButton();
        });
        
        return item;
    }

    // Display no changes message
    function displayNoChanges() {
        changesContainer.innerHTML = `
            <div class="no-changes">
                <h3>No Changes Suggested</h3>
                <p>The AI verification found that your current data is accurate and up-to-date. No changes are needed.</p>
            </div>
        `;
        changesContainer.style.display = 'block';
    }

    // Reset all
    resetButton.addEventListener('click', function() {
        approvedChanges.clear();
        updateApplyButton();
        
        // Reset all approve/reject buttons
        document.querySelectorAll('.btn-approve').forEach(btn => {
            btn.classList.remove('approved');
        });
        document.querySelectorAll('.btn-reject').forEach(btn => {
            btn.classList.remove('rejected');
        });
    });

    // Run verification again
    runAgainButton.addEventListener('click', function() {
        // Reset UI
        summaryCards.style.display = 'none';
        changesContainer.style.display = 'none';
        actionPanel.style.display = 'none';
        markdownReportContainer.style.display = 'none';
        initialPanel.style.display = 'block';
        approvedChanges.clear();
        updateStatus('ready', 'Ready for AI Review');
        
        // Trigger verification
        runButton.click();
    });

    // Generate a simple markdown report from the available data
    function generateSimpleMarkdownReport(data, aiData) {
        const timestamp = new Date().toLocaleString();
        const resourceName = '{{ resource.name }}';
        
        let report = [];
        report.push('# Resource Verification Report');
        report.push('');
        report.push('## 📊 Verification Summary');
        report.push('');
        report.push(`- **Resource**: ${resourceName}`);
        report.push(`- **Verification Date**: ${timestamp}`);
        report.push(`- **Overall Status**: ✅ Complete`);
        report.push(`- **Verification Method**: AI-Assisted`);
        report.push('');
        
        if (data.summary) {
            report.push('### 📈 Verification Statistics');
            report.push('');
            report.push(`- **Total Changes**: ${data.summary.total_changes}`);
            report.push(`- **Fields Verified**: ${data.summary.total_verified || data.summary.total_changes}`);
            report.push(`- **High Confidence**: ${data.summary.high_confidence}`);
            report.push(`- **Medium Confidence**: ${data.summary.medium_confidence}`);
            report.push(`- **Low Confidence**: ${data.summary.low_confidence}`);
            report.push('');
        }
        
        if (aiData && aiData.changes) {
            report.push('## 🔍 Suggested Changes');
            report.push('');
            
            // Group changes by category
            const changesByCategory = {};
            aiData.changes.forEach(change => {
                if (!changesByCategory[change.category]) {
                    changesByCategory[change.category] = [];
                }
                changesByCategory[change.category].push(change);
            });
            
            Object.entries(changesByCategory).forEach(([category, changes]) => {
                report.push(`### ${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`);
                report.push('');
                
                changes.forEach(change => {
                    report.push(`#### ${change.field_name}`);
                    report.push('');
                    report.push('| Field | Current Value | Suggested Value | Confidence |');
                    report.push('|-------|---------------|-----------------|------------|');
                    report.push(`| ${change.field_name} | ${change.current_value || 'Not specified'} | ${change.suggested_value || 'Not specified'} | ${change.confidence} |`);
                    report.push('');
                    report.push(`**Reasoning**: ${change.reasoning}`);
                    report.push('');
                });
            });
        }
        
        if (aiData && aiData.verified_fields) {
            report.push('## ✅ Verified Fields');
            report.push('');
            
            // Group verified fields by category
            const verifiedByCategory = {};
            aiData.verified_fields.forEach(field => {
                if (!verifiedByCategory[field.category]) {
                    verifiedByCategory[field.category] = [];
                }
                verifiedByCategory[field.category].push(field);
            });
            
            Object.entries(verifiedByCategory).forEach(([category, fields]) => {
                report.push(`### ${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`);
                report.push('');
                
                fields.forEach(field => {
                    report.push(`- **${field.field_name}**: ${field.current_value || 'Not specified'} (${field.confidence} confidence)`);
                });
                report.push('');
            });
        }
        
        report.push('## 🛠️ Tools & Methods Used');
        report.push('');
        report.push('- **AI Model**: meta-llama/llama-4-maverick:free');
        report.push('- **Web Search**: DuckDuckGo authoritative search');
        report.push('- **Website Scraping**: BeautifulSoup content extraction');
        report.push('- **Format Validation**: Regex pattern matching');
        report.push('- **Content Analysis**: AI-powered content verification');
        report.push('');
        
        report.push('## 📋 Metadata');
        report.push('');
        report.push('- **Verification System**: AI Review Service v1.0');
        report.push('- **AI Model**: meta-llama/llama-4-maverick:free');
        report.push('- **Web Search Tool**: DuckDuckGo');
        report.push('- **Scraping Tool**: BeautifulSoup');
        report.push('- **Validation Tools**: Custom regex patterns');
        report.push('');
        
        return report.join('\n');
    }

    // Display Markdown report
    function displayMarkdownReport(markdownText) {
        console.log('displayMarkdownReport called with length:', markdownText.length);
        
        // Simple Markdown to HTML conversion
        let html = markdownText
            // Headers
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            // Bold
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Italic
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Code blocks
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
            // Inline code
            .replace(/`(.*?)`/g, '<code>$1</code>')
            // Links
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
            // Lists
            .replace(/^\* (.*$)/gim, '<li>$1</li>')
            .replace(/^- (.*$)/gim, '<li>$1</li>')
            // Tables (basic support)
            .replace(/\| (.*?) \|/g, '<td>$1</td>')
            // Line breaks
            .replace(/\n/g, '<br>');
        
        // Wrap lists properly
        html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
        
        // Clean up table formatting
        html = html.replace(/<td>(.*?)<\/td>/g, function(match, content) {
            if (content.includes('---')) {
                return ''; // Skip separator rows
            }
            return match;
        });
        
        // Add table wrapper for better formatting
        html = html.replace(/(<td>.*<\/td>)/g, '<table><tr>$1</tr></table>');
        
        markdownContent.innerHTML = html;
        markdownReportContainer.style.display = 'block';
        console.log('Markdown report container displayed');
        console.log('Report content length:', html.length);
        console.log('HTML preview:', html.substring(0, 300) + '...');
    }
</script>
{% endblock %}
