{% extends 'base.html' %}

{% block title %}{{ action }} Resource - Resource Directory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ action }} Resource</h1>
            <a href="{% url 'directory:resource_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Resources
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h5>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Resource Name <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.category.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.service_types.id_for_label }}" class="form-label">Service Types</label>
                            {{ form.service_types }}
                            {% if form.service_types.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.service_types.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Select all service types that apply to this resource.
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Minimum 20 characters required for review status.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-phone"></i> Contact Information
                            </h5>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.website.id_for_label }}" class="form-label">Website</label>
                            {{ form.website }}
                            {% if form.website.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.website.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt"></i> Location
                            </h5>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.address1.id_for_label }}" class="form-label">Address Line 1</label>
                            {{ form.address1 }}
                            {% if form.address1.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address1.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.address2.id_for_label }}" class="form-label">Address Line 2</label>
                            {{ form.address2 }}
                            {% if form.address2.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address2.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.city.id_for_label }}" class="form-label">City</label>
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.city.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.state.id_for_label }}" class="form-label">State</label>
                            {{ form.state }}
                            {% if form.state.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.state.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.county.id_for_label }}" class="form-label">County</label>
                            {{ form.county }}
                            {% if form.county.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.county.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.postal_code.id_for_label }}" class="form-label">Postal Code</label>
                            {{ form.postal_code }}
                            {% if form.postal_code.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.postal_code.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Service Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-cogs"></i> Service Details
                            </h5>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hours_of_operation.id_for_label }}" class="form-label">Hours of Operation</label>
                            {{ form.hours_of_operation }}
                            {% if form.hours_of_operation.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.hours_of_operation.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Service hours and availability (e.g., Mon-Fri 9AM-5PM, 24/7)
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                {{ form.is_emergency_service }}
                                <label class="form-check-label" for="{{ form.is_emergency_service.id_for_label }}">
                                    Emergency Service
                                </label>
                                {% if form.is_emergency_service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_emergency_service.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Mark if this is a crisis or emergency service
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                {{ form.is_24_hour_service }}
                                <label class="form-check-label" for="{{ form.is_24_hour_service.id_for_label }}">
                                    24/7 Service
                                </label>
                                {% if form.is_24_hour_service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_24_hour_service.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Mark if this service is available 24/7
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.languages_available.id_for_label }}" class="form-label">Languages Available</label>
                            {{ form.languages_available }}
                            {% if form.languages_available.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.languages_available.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Languages supported for accessibility
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.capacity.id_for_label }}" class="form-label">Capacity</label>
                            {{ form.capacity }}
                            {% if form.capacity.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.capacity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Service capacity information
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.eligibility_requirements.id_for_label }}" class="form-label">Eligibility Requirements</label>
                            {{ form.eligibility_requirements }}
                            {% if form.eligibility_requirements.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.eligibility_requirements.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Qualification criteria and requirements
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.populations_served.id_for_label }}" class="form-label">Populations Served</label>
                            {{ form.populations_served }}
                            {% if form.populations_served.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.populations_served.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Target demographics (e.g., veterans, women, children)
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.insurance_accepted.id_for_label }}" class="form-label">Insurance Accepted</label>
                            {{ form.insurance_accepted }}
                            {% if form.insurance_accepted.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.insurance_accepted.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Insurance plans accepted for medical services
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.cost_information.id_for_label }}" class="form-label">Cost Information</label>
                            {{ form.cost_information }}
                            {% if form.cost_information.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cost_information.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Financial details and cost information
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status and Verification -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-check-circle"></i> Status and Verification
                            </h5>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.source.id_for_label }}" class="form-label">Source</label>
                            {{ form.source }}
                            {% if form.source.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.source.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Required for review status.
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Verification Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <strong>Important:</strong> Use this field to track verification sources, contact information, and verification details. Include:
                                <ul class="mt-1 mb-0">
                                    <li>Contact person name and phone number</li>
                                    <li>Date contacted</li>
                                    <li>Website URLs used for verification</li>
                                    <li>Any special notes about the verification process</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.last_verified_at.id_for_label }}" class="form-label">Last Verified</label>
                            {{ form.last_verified_at }}
                            {% if form.last_verified_at.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.last_verified_at.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_verified_by.id_for_label }}" class="form-label">Verified By</label>
                            {{ form.last_verified_by }}
                            {% if form.last_verified_by.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.last_verified_by.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Service Areas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marked-alt"></i> Service Areas
                            </h5>
                            <p class="text-muted small mb-3">
                                Define the geographic areas where this resource provides services. You can use administrative boundaries, 
                                create custom radius areas, or draw custom polygons.
                            </p>
                            
                            <!-- Current Service Areas Display -->
                            <div id="currentServiceAreas" class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Current Service Areas</h6>
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#serviceAreaModal">
                                        <i class="fas fa-plus me-1"></i>Add Service Area
                                    </button>
                                </div>
                                <div id="serviceAreasList" class="list-group">
                                    <!-- Service areas will be populated by JavaScript -->
                                    <div class="text-muted small">No service areas defined yet. Click "Add Service Area" to get started.</div>
                                </div>
                            </div>
                            
                            <!-- Service Areas Summary -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Service Areas Help:</strong> Define where your resource operates to help people find services in their area. 
                                You can add multiple service areas of different types.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'directory:resource_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Resource
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include Service Area Manager Modal -->
{% include 'directory/service_area_manager_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // Add Bootstrap classes to form fields
    document.addEventListener('DOMContentLoaded', function() {
        const formFields = document.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            if (field.classList.contains('form-control')) {
                if (field.hasAttribute('data-invalid') || field.classList.contains('is-invalid')) {
                    field.classList.add('is-invalid');
                }
            }
        });
        
        // Initialize Service Area Manager
        initializeServiceAreaManager();
    });
    
    // Service Area Manager functionality
    function initializeServiceAreaManager() {
        // Store selected service areas
        let selectedServiceAreas = [];
        
        // Map instances for each tab
        let boundaryMap = null;
        let radiusMap = null;
        let polygonMap = null;
        let uploadMap = null;
        
        // Drawing layers
        let drawingLayer = null;
        let drawnItems = null;
        
        // Initialize radius slider
        const radiusSlider = document.getElementById('radiusMiles');
        const radiusValue = document.getElementById('radiusValue');
        if (radiusSlider && radiusValue) {
            radiusSlider.addEventListener('input', function() {
                radiusValue.textContent = this.value + ' miles';
            });
        }
        
        // Initialize maps when modal is shown
        const serviceAreaModal = document.getElementById('serviceAreaModal');
        if (serviceAreaModal) {
            serviceAreaModal.addEventListener('shown.bs.modal', function() {
                initializeMaps();
            });
            
            serviceAreaModal.addEventListener('hidden.bs.modal', function() {
                cleanupMaps();
            });
        }
        
        // Tab change event to initialize maps
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                initializeMapForTab(targetId);
            });
        });
        
        // Handle boundary search form
        const boundarySearchForm = document.getElementById('boundarySearchForm');
        if (boundarySearchForm) {
            boundarySearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                searchBoundaries();
            });
        }
        
        // Handle radius form
        const radiusForm = document.getElementById('radiusForm');
        if (radiusForm) {
            radiusForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createRadiusArea();
            });
        }
        
        // Handle polygon form
        const polygonForm = document.getElementById('polygonForm');
        if (polygonForm) {
            polygonForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createPolygonArea();
            });
        }
        
        // Handle upload form
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                uploadGeoJSON();
            });
        }
        
        // Handle save button
        const saveBtn = document.getElementById('saveServiceAreasBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveServiceAreas();
            });
        }
        
        // Map initialization functions
        function initializeMaps() {
            // Initialize the first tab (boundary) by default
            initializeMapForTab('#boundary');
        }
        
        function initializeMapForTab(tabId) {
            switch(tabId) {
                case '#boundary':
                    if (!boundaryMap) {
                        boundaryMap = createMap('boundaryMapPreview', [37.1283, -84.0836], 8);
                    }
                    break;
                case '#radius':
                    if (!radiusMap) {
                        radiusMap = createMap('radiusMapPreview', [37.1283, -84.0836], 10);
                        setupRadiusMap(radiusMap);
                    }
                    break;
                case '#polygon':
                    if (!polygonMap) {
                        polygonMap = createMap('polygonMapCanvas', [37.1283, -84.0836], 10);
                        setupPolygonMap(polygonMap);
                    }
                    break;
                case '#upload':
                    if (!uploadMap) {
                        uploadMap = createMap('uploadPreview', [37.1283, -84.0836], 8);
                    }
                    break;
            }
        }
        
        function createMap(containerId, center, zoom) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            // Create map instance
            const map = L.map(containerId, {
                center: center,
                zoom: zoom,
                zoomControl: true,
                attributionControl: true
            });
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Force map resize after initialization
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            return map;
        }
        
        function setupRadiusMap(map) {
            let centerMarker = null;
            let radiusCircle = null;
            
            // Add click handler to set center point
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Update center input
                document.getElementById('radiusCenter').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                // Remove existing marker and circle
                if (centerMarker) map.removeLayer(centerMarker);
                if (radiusCircle) map.removeLayer(radiusCircle);
                
                // Add new marker
                centerMarker = L.marker([lat, lng]).addTo(map);
                
                // Add radius circle
                const radiusMiles = parseFloat(document.getElementById('radiusMiles').value);
                const radiusMeters = radiusMiles * 1609.34;
                radiusCircle = L.circle([lat, lng], {
                    radius: radiusMeters,
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.2,
                    weight: 2
                }).addTo(map);
                
                // Fit map to circle
                map.fitBounds(radiusCircle.getBounds());
            });
            
            // Update radius circle when slider changes
            document.getElementById('radiusMiles').addEventListener('input', function() {
                if (centerMarker && radiusCircle) {
                    const radiusMiles = parseFloat(this.value);
                    const radiusMeters = radiusMiles * 1609.34;
                    const center = centerMarker.getLatLng();
                    
                    map.removeLayer(radiusCircle);
                    radiusCircle = L.circle([center.lat, center.lng], {
                        radius: radiusMeters,
                        color: '#007bff',
                        fillColor: '#007bff',
                        fillOpacity: 0.2,
                        weight: 2
                    }).addTo(map);
                }
            });
        }
        
        function setupPolygonMap(map) {
            // Initialize drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Initialize draw control
            drawingLayer = new L.Control.Draw({
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Error:</strong> Shape edges cannot cross!'
                        },
                        shapeOptions: {
                            color: '#007bff',
                            fillColor: '#007bff',
                            fillOpacity: 0.2,
                            weight: 2
                        }
                    },
                    circle: false,
                    rectangle: false,
                    polyline: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            map.addControl(drawingLayer);
            
            // Handle drawing events
            map.on('draw:created', function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);
                
                // Update polygon info
                updatePolygonInfo(layer);
                
                // Enable create button
                document.getElementById('createPolygonBtn').disabled = false;
            });
            
            map.on('draw:edited', function(e) {
                const layers = e.layers;
                layers.eachLayer(function(layer) {
                    updatePolygonInfo(layer);
                });
            });
            
            map.on('draw:deleted', function(e) {
                document.getElementById('createPolygonBtn').disabled = true;
                document.getElementById('vertexCount').textContent = '0';
                document.getElementById('polygonArea').textContent = '0';
            });
        }
        
        function updatePolygonInfo(layer) {
            if (layer instanceof L.Polygon) {
                const coords = layer.getLatLngs()[0];
                const vertexCount = coords.length;
                const area = L.GeometryUtil.geodesicArea(coords);
                const areaSqMiles = area * 0.000000386102; // Convert square meters to square miles
                
                document.getElementById('vertexCount').textContent = vertexCount;
                document.getElementById('polygonArea').textContent = areaSqMiles.toFixed(2);
            }
        }
        
        function cleanupMaps() {
            // Clean up map instances to prevent memory leaks
            if (boundaryMap) {
                boundaryMap.remove();
                boundaryMap = null;
            }
            if (radiusMap) {
                radiusMap.remove();
                radiusMap = null;
            }
            if (polygonMap) {
                polygonMap.remove();
                polygonMap = null;
            }
            if (uploadMap) {
                uploadMap.remove();
                uploadMap = null;
            }
            
            // Reset drawing layers
            drawingLayer = null;
            drawnItems = null;
        }
        
        // Search boundaries function
        function searchBoundaries() {
            const kind = document.getElementById('boundaryKind').value;
            const query = document.getElementById('boundarySearch').value;
            
            if (!query.trim()) {
                showToast('Please enter a search term', 'warning');
                return;
            }
            
            // Show loading
            showLoading(true);
            
            // Make API call to search boundaries
            fetch(`/api/areas/search/?kind=${kind}&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    showLoading(false);
                    displayBoundaryResults(data.results);
                })
                .catch(error => {
                    showLoading(false);
                    showToast('Error searching boundaries: ' + error.message, 'error');
                });
        }
        
        // Display boundary search results
        function displayBoundaryResults(results) {
            const resultsContainer = document.getElementById('boundaryResults');
            const resultsList = document.getElementById('boundaryResultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<div class="text-muted small">No boundaries found matching your search.</div>';
            } else {
                resultsList.innerHTML = results.map(area => `
                    <div class="list-group-item list-group-item-action" onclick="selectBoundary(${area.id})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${area.name}</h6>
                                <small class="text-muted">${area.kind}</small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); selectBoundary(${area.id})">
                                <i class="fas fa-plus"></i> Select
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }
        
        // Select a boundary
        window.selectBoundary = function(areaId) {
            // Add to selected areas
            selectedServiceAreas.push({
                id: areaId,
                type: 'boundary',
                source: 'existing'
            });
            
            showToast('Boundary selected successfully', 'success');
            updateServiceAreasList();
        };
        
        // Create radius area
        function createRadiusArea() {
            const name = document.getElementById('radiusName').value;
            const center = document.getElementById('radiusCenter').value;
            const radiusMiles = document.getElementById('radiusMiles').value;
            
            if (!name || !center) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Make API call to create radius area
            fetch('/api/areas/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'radius',
                    name: name,
                    center: [37.1283, -84.0836], // Default to London, KY for now
                    radius_miles: parseFloat(radiusMiles)
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.id) {
                    selectedServiceAreas.push({
                        id: data.id,
                        name: data.name,
                        type: 'radius',
                        source: 'new'
                    });
                    showToast('Radius area created successfully', 'success');
                    updateServiceAreasList();
                    document.getElementById('radiusForm').reset();
                } else {
                    showToast('Error creating radius area: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('Error creating radius area: ' + error.message, 'error');
            });
        }
        
        // Create polygon area
        function createPolygonArea() {
            const name = document.getElementById('polygonName').value;
            
            if (!name) {
                showToast('Please enter an area name', 'warning');
                return;
            }
            
            if (!drawnItems || drawnItems.getLayers().length === 0) {
                showToast('Please draw a polygon first', 'warning');
                return;
            }
            
            const layer = drawnItems.getLayers()[0];
            if (!(layer instanceof L.Polygon)) {
                showToast('Please draw a valid polygon', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Convert Leaflet polygon to GeoJSON
            const geojson = layer.toGeoJSON();
            
            // Make API call to create polygon area
            fetch('/api/areas/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'polygon',
                    name: name,
                    geometry: geojson
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.id) {
                    selectedServiceAreas.push({
                        id: data.id,
                        name: data.name,
                        type: 'polygon',
                        source: 'new'
                    });
                    showToast('Polygon area created successfully', 'success');
                    updateServiceAreasList();
                    document.getElementById('polygonForm').reset();
                    
                    // Clear the drawn polygon
                    drawnItems.clearLayers();
                    document.getElementById('createPolygonBtn').disabled = true;
                    document.getElementById('vertexCount').textContent = '0';
                    document.getElementById('polygonArea').textContent = '0';
                } else {
                    showToast('Error creating polygon area: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('Error creating polygon area: ' + error.message, 'error');
            });
        }
        
        // Upload GeoJSON (placeholder)
        function uploadGeoJSON() {
            showToast('GeoJSON upload will be implemented in the next phase', 'info');
        }
        
        // Save service areas to resource
        function saveServiceAreas() {
            // This will be implemented when we add the resource-coverage association API
            showToast('Service areas will be saved to the resource in the next phase', 'info');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('serviceAreaModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // Update service areas list display
        function updateServiceAreasList() {
            const listContainer = document.getElementById('serviceAreasList');
            
            if (selectedServiceAreas.length === 0) {
                listContainer.innerHTML = '<div class="text-muted small">No service areas defined yet. Click "Add Service Area" to get started.</div>';
            } else {
                listContainer.innerHTML = selectedServiceAreas.map(area => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${area.name || 'Area ' + area.id}</h6>
                            <small class="text-muted">${area.type} • ${area.source === 'new' ? 'New' : 'Existing'}</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeServiceArea(${area.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        }
        
        // Remove service area
        window.removeServiceArea = function(areaId) {
            selectedServiceAreas = selectedServiceAreas.filter(area => area.id !== areaId);
            updateServiceAreasList();
            showToast('Service area removed', 'success');
        };
        
        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('d-none', !show);
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('serviceAreaToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            if (toast && toastTitle && toastMessage) {
                // Set icon and title based on type
                const icons = {
                    'success': 'fas fa-check-circle text-success',
                    'error': 'fas fa-exclamation-circle text-danger',
                    'warning': 'fas fa-exclamation-triangle text-warning',
                    'info': 'fas fa-info-circle text-info'
                };
                
                toastTitle.innerHTML = `<i class="${icons[type] || icons.info} me-2"></i>Service Area Manager`;
                toastMessage.textContent = message;
                
                // Show toast
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            }
        }
    }
</script>
{% endblock %}
