{% extends 'base.html' %}

{% block title %}{{ action }} Resource - Resource Directory{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ action }} Resource</h1>
            <a href="{% url 'directory:resource_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Resources
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Hidden input for service areas data -->
                    <input type="hidden" id="initialServiceAreasData" value="{{ service_areas_data|default:'[]' }}">
                    
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle"></i> Basic Information
                            </h5>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Resource Name <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.category.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.service_types.id_for_label }}" class="form-label">Service Types</label>
                            {{ form.service_types }}
                            {% if form.service_types.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.service_types.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Select all service types that apply to this resource.
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Minimum 20 characters required for review status.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-phone"></i> Contact Information
                            </h5>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.website.id_for_label }}" class="form-label">Website</label>
                            {{ form.website }}
                            {% if form.website.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.website.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt"></i> Location
                            </h5>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.address1.id_for_label }}" class="form-label">Address Line 1</label>
                            {{ form.address1 }}
                            {% if form.address1.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address1.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.address2.id_for_label }}" class="form-label">Address Line 2</label>
                            {{ form.address2 }}
                            {% if form.address2.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address2.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.city.id_for_label }}" class="form-label">City</label>
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.city.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.state.id_for_label }}" class="form-label">State</label>
                            {{ form.state }}
                            {% if form.state.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.state.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.county.id_for_label }}" class="form-label">County</label>
                            {{ form.county }}
                            {% if form.county.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.county.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.postal_code.id_for_label }}" class="form-label">Postal Code</label>
                            {{ form.postal_code }}
                            {% if form.postal_code.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.postal_code.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Service Details -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-cogs"></i> Service Details
                            </h5>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.hours_of_operation.id_for_label }}" class="form-label">Hours of Operation</label>
                            {{ form.hours_of_operation }}
                            {% if form.hours_of_operation.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.hours_of_operation.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Service hours and availability (e.g., Mon-Fri 9AM-5PM, 24/7)
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                {{ form.is_emergency_service }}
                                <label class="form-check-label" for="{{ form.is_emergency_service.id_for_label }}">
                                    Emergency Service
                                </label>
                                {% if form.is_emergency_service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_emergency_service.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Mark if this is a crisis or emergency service
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                {{ form.is_24_hour_service }}
                                <label class="form-check-label" for="{{ form.is_24_hour_service.id_for_label }}">
                                    24/7 Service
                                </label>
                                {% if form.is_24_hour_service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_24_hour_service.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Mark if this service is available 24/7
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.languages_available.id_for_label }}" class="form-label">Languages Available</label>
                            {{ form.languages_available }}
                            {% if form.languages_available.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.languages_available.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Languages supported for accessibility
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.capacity.id_for_label }}" class="form-label">Capacity</label>
                            {{ form.capacity }}
                            {% if form.capacity.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.capacity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Service capacity information
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.eligibility_requirements.id_for_label }}" class="form-label">Eligibility Requirements</label>
                            {{ form.eligibility_requirements }}
                            {% if form.eligibility_requirements.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.eligibility_requirements.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Qualification criteria and requirements
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.populations_served.id_for_label }}" class="form-label">Populations Served</label>
                            {{ form.populations_served }}
                            {% if form.populations_served.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.populations_served.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Target demographics (e.g., veterans, women, children)
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.insurance_accepted.id_for_label }}" class="form-label">Insurance Accepted</label>
                            {{ form.insurance_accepted }}
                            {% if form.insurance_accepted.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.insurance_accepted.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Insurance plans accepted for medical services
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.cost_information.id_for_label }}" class="form-label">Cost Information</label>
                            {{ form.cost_information }}
                            {% if form.cost_information.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cost_information.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Financial details and cost information
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status and Verification -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-check-circle"></i> Status and Verification
                            </h5>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.source.id_for_label }}" class="form-label">Source</label>
                            {{ form.source }}
                            {% if form.source.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.source.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Required for review status.
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Verification Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <strong>Important:</strong> Use this field to track verification sources, contact information, and verification details. Include:
                                <ul class="mt-1 mb-0">
                                    <li>Contact person name and phone number</li>
                                    <li>Date contacted</li>
                                    <li>Website URLs used for verification</li>
                                    <li>Any special notes about the verification process</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.last_verified_at.id_for_label }}" class="form-label">Last Verified</label>
                            {{ form.last_verified_at }}
                            {% if form.last_verified_at.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.last_verified_at.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_verified_by.id_for_label }}" class="form-label">Verified By</label>
                            {{ form.last_verified_by }}
                            {% if form.last_verified_by.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.last_verified_by.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Service Areas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marked-alt"></i> Service Areas
                                <span class="badge bg-primary ms-2">Step 4 of 4</span>
                            </h5>
                            <p class="text-muted small mb-3">
                                <strong>Important:</strong> Define the geographic areas where this resource provides services. 
                                This helps people find services in their area and improves search results.
                            </p>
                            
                            <!-- Service Areas Progress Indicator -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Service Areas Status:</strong>
                                        <span id="serviceAreasStatus" class="ms-2">
                                            <span class="badge bg-warning">Not configured</span>
                                        </span>
                                        {% if is_edit %}
                                        <div class="small text-muted mt-1">
                                            <i class="fas fa-edit me-1"></i>Edit mode: You can modify existing service areas or add new ones
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if is_edit %}
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#serviceAreaModal">
                                            <i class="fas fa-edit me-1"></i>Manage Areas
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm me-2" id="saveServiceAreasOnlyBtn" onclick="saveServiceAreasOnly()">
                                            <i class="fas fa-save me-1"></i>Save Service Areas
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#serviceAreaModal">
                                            <i class="fas fa-plus me-1"></i>Configure Service Areas
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Service Areas Display -->
                            <div id="currentServiceAreas" class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">
                                        <i class="fas fa-list me-1"></i>Current Service Areas
                                        <span id="serviceAreasCount" class="badge bg-secondary ms-2">0</span>
                                        {% if is_edit %}
                                        <span class="badge bg-info ms-1">Editing</span>
                                        {% endif %}
                                    </h6>
                                    <div>
                                        {% if is_edit %}
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#serviceAreaModal">
                                            <i class="fas fa-edit me-1"></i>Edit Areas
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#serviceAreaModal">
                                            <i class="fas fa-plus me-1"></i>Add More
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllServiceAreas()">
                                            <i class="fas fa-trash me-1"></i>Clear All
                                        </button>
                                    </div>
                                </div>
                                <div id="serviceAreasList" class="list-group">
                                    <!-- Service areas will be populated by JavaScript -->
                                    <div class="text-muted small p-3 text-center">
                                        <i class="fas fa-map-marker-alt fa-2x mb-2 text-muted"></i>
                                        <div>No service areas defined yet.</div>
                                        <div class="small">
                                            {% if is_edit %}
                                            Click "Edit Areas" to manage service areas for this resource.
                                            {% else %}
                                            Click "Configure Service Areas" to get started.
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Areas Summary -->
                            <div class="alert alert-success" id="serviceAreasSummary" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Service Areas Configured!</strong>
                                        <div class="small">Your resource will now appear in location-based searches for the selected areas.</div>
                                        <div class="small mt-1">
                                            <strong>Search Impact:</strong> 
                                            <span id="searchImpactText">Users searching in these areas will find your resource.</span>
                                        </div>
                                    </div>
                                    <div class="ms-3">
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="showSearchPreview()">
                                            <i class="fas fa-search me-1"></i>Preview Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Areas Help -->
                            <div class="alert alert-light">
                                <h6 class="alert-heading">
                                    <i class="fas fa-question-circle me-1"></i>Service Areas Help
                                </h6>
                                <p class="mb-2">Service areas define where your resource operates and help people find services in their area:</p>
                                <ul class="mb-0 small">
                                    <li><strong>Administrative Boundaries:</strong> Counties, cities, and states (e.g., "Laurel County, KY")</li>
                                    <li><strong>Radius Areas:</strong> Custom circular areas around a specific location</li>
                                    <li><strong>Custom Polygons:</strong> Draw custom shapes for specific service areas</li>
                                    <li><strong>Upload GeoJSON:</strong> Import complex boundaries from external files</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'directory:resource_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Resource
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include Service Area Manager Modal -->
{% include 'directory/service_area_manager_modal.html' %}
{% endblock %}

{% block extra_js %}
<style>
    /* Custom tooltip styles */
    .custom-tooltip {
        background: rgba(0, 0, 0, 0.8);
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 12px;
        padding: 8px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .custom-tooltip::before {
        border-top-color: rgba(0, 0, 0, 0.8);
    }
    
    /* Custom marker styles */
    .custom-marker {
        background: transparent;
        border: none;
    }
    
    .custom-marker.selected {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
    
    /* Map interaction hints */
    .map-hint {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    // Add Bootstrap classes to form fields
    document.addEventListener('DOMContentLoaded', function() {
        const formFields = document.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            if (field.classList.contains('form-control')) {
                if (field.hasAttribute('data-invalid') || field.classList.contains('is-invalid')) {
                    field.classList.add('is-invalid');
                }
            }
        });
        
            // Initialize Service Area Manager
    initializeServiceAreaManager();
    
    });
    
    // Function to save only service areas (defined early so button can call it)
    function saveServiceAreasOnly() {
        const resourceId = getResourceId();
        if (!resourceId) {
            showToast('Could not determine resource ID', 'error');
            return;
        }
        
        showLoading(true);
        
        // Prepare the data
        const coverageAreaIds = selectedServiceAreas.map(area => area.id);
        const requestData = {
            action: 'replace', // Use 'replace' to clear existing and add new
            coverage_area_ids: coverageAreaIds,
            notes: 'Updated via Save Service Areas button'
        };
        
        // Make API call to save areas
        fetch(`/api/resources/${resourceId}/areas/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            
            if (data.success) {
                const message = coverageAreaIds.length > 0 
                    ? `Successfully saved ${data.attached_count} service areas`
                    : 'Successfully cleared all service areas';
                showToast(message, 'success');
                
                // Refresh the page to show updated state
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                const errorMessage = data.errors && data.errors.length > 0 
                    ? data.errors.join(', ') 
                    : (data.error || 'Unknown error occurred');
                showToast('Error saving service areas: ' + errorMessage, 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            showToast('Error saving service areas: ' + error.message, 'error');
        });
    }
    
    // Get resource ID from the current page (defined early so other functions can call it)
    function getResourceId() {
        // Try to get from URL first
        const urlMatch = window.location.pathname.match(/\/manage\/resources\/(\d+)/);
        if (urlMatch) {
            return urlMatch[1];
        }
        
        // Try to get from form data
        const resourceIdInput = document.querySelector('input[name="resource_id"]');
        if (resourceIdInput) {
            return resourceIdInput.value;
        }
        
        // Try to get from hidden field
        const hiddenResourceId = document.querySelector('input[name="id"]');
        if (hiddenResourceId) {
            return hiddenResourceId.value;
        }
        
        return null;
    }
    
    // Utility functions (defined early so other functions can call them)
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.toggle('d-none', !show);
        }
    }
    
    function showToast(message, type = 'info') {
        const toast = document.getElementById('serviceAreaToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        
        if (toast && toastTitle && toastMessage) {
            // Set icon and title based on type
            const icons = {
                'success': 'fas fa-check-circle text-success',
                'error': 'fas fa-exclamation-circle text-danger',
                'warning': 'fas fa-exclamation-triangle text-warning',
                'info': 'fas fa-info-circle text-info'
            };
            
            toastTitle.innerHTML = `<i class="${icons[type] || icons.info} me-2"></i>Service Area Manager`;
            toastMessage.textContent = message;
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    }
    
    // Global variables for service areas
    let selectedServiceAreas = [];
    
    // Service Area Manager functionality
    function initializeServiceAreaManager() {
        
        // Store search results for map display
        let currentSearchResults = [];
        
        // Map instances for each tab
        let boundaryMap = null;
        let radiusMap = null;
        let polygonMap = null;
        let uploadMap = null;
        
        // Drawing layers
        let drawingLayer = null;
        let drawnItems = null;
        
        // Load initial service areas data if available
        loadInitialServiceAreas();
        
        // Initialize radius slider
        const radiusSlider = document.getElementById('radiusMiles');
        const radiusValue = document.getElementById('radiusValue');
        if (radiusSlider && radiusValue) {
            radiusSlider.addEventListener('input', function() {
                radiusValue.textContent = this.value + ' miles';
            });
        }
        
        // Initialize maps when modal is shown
        const serviceAreaModal = document.getElementById('serviceAreaModal');
        if (serviceAreaModal) {
            serviceAreaModal.addEventListener('shown.bs.modal', function() {
                initializeMaps();
                loadExistingServiceAreas(); // Load existing areas when modal opens
                updateModalContext(); // Update modal for edit mode
            });
            
            serviceAreaModal.addEventListener('hidden.bs.modal', function() {
                cleanupMaps();
            });
        }
        
        // Tab change event to initialize maps
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                initializeMapForTab(targetId);
            });
        });
        
        // Handle boundary search form
        const boundarySearchForm = document.getElementById('boundarySearchForm');
        if (boundarySearchForm) {
            boundarySearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                searchBoundaries();
            });
        }
        
        // Handle radius form
        const radiusForm = document.getElementById('radiusForm');
        if (radiusForm) {
            radiusForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createRadiusArea();
            });
        }
        
        // Handle geocoding button
        const geocodeBtn = document.getElementById('geocodeBtn');
        if (geocodeBtn) {
            geocodeBtn.addEventListener('click', function() {
                geocodeAddress();
            });
        }
        
        // Geocode address function
        function geocodeAddress() {
            const address = document.getElementById('radiusCenter').value;
            
            if (!address.trim()) {
                showToast('Please enter an address to geocode', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Use the geocoding service
            fetch(`/api/search/by-location/?address=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    showLoading(false);
                    if (data.location && data.location.coordinates) {
                        const [lat, lng] = data.location.coordinates;
                        document.getElementById('radiusCenter').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        
                        // Update map if available
                        if (radiusMap) {
                            const center = L.latLng(lat, lng);
                            radiusMap.setView(center, 12);
                            
                            // Trigger click event to set center
                            radiusMap.fire('click', { latlng: center });
                        }
                        
                        showToast('Address geocoded successfully', 'success');
                    } else {
                        showToast('Could not geocode address. Please try a different address or enter coordinates manually.', 'error');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showToast('Error geocoding address: ' + error.message, 'error');
                });
        }
        
        // Handle polygon form
        const polygonForm = document.getElementById('polygonForm');
        if (polygonForm) {
            polygonForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createPolygonArea();
            });
        }
        
        // Handle polygon drawing controls
        const startDrawingBtn = document.getElementById('startDrawingBtn');
        const clearDrawingBtn = document.getElementById('clearDrawingBtn');
        
        if (startDrawingBtn) {
            startDrawingBtn.addEventListener('click', function() {
                if (polygonMap && drawingLayer) {
                    // Enable polygon drawing
                    drawingLayer.setDrawingOptions({
                        polygon: {
                            allowIntersection: false,
                            drawError: {
                                color: '#e1e100',
                                message: '<strong>Error:</strong> Shape edges cannot cross!'
                            },
                            shapeOptions: {
                                color: '#007bff',
                                fillColor: '#007bff',
                                fillOpacity: 0.2,
                                weight: 2
                            }
                        }
                    });
                    
                    // Start drawing mode
                    const drawControl = new L.Control.Draw({
                        draw: {
                            polygon: {
                                allowIntersection: false,
                                drawError: {
                                    color: '#e1e100',
                                    message: '<strong>Error:</strong> Shape edges cannot cross!'
                                },
                                shapeOptions: {
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.2,
                                    weight: 2
                                }
                            },
                            circle: false,
                            rectangle: false,
                            polyline: false,
                            marker: false,
                            circlemarker: false
                        },
                        edit: {
                            featureGroup: drawnItems,
                            remove: true
                        }
                    });
                    
                    polygonMap.addControl(drawControl);
                    showToast('Click on the map to start drawing your polygon', 'info');
                }
            });
        }
        
        if (clearDrawingBtn) {
            clearDrawingBtn.addEventListener('click', function() {
                if (drawnItems) {
                    drawnItems.clearLayers();
                    document.getElementById('createPolygonBtn').disabled = true;
                    document.getElementById('vertexCount').textContent = '0';
                    document.getElementById('polygonArea').textContent = '0';
                    showToast('Drawing cleared', 'info');
                }
            });
        }
        
        // Handle upload form
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                uploadGeoJSON();
            });
        }
        
        // Handle save button
        const saveBtn = document.getElementById('saveServiceAreasBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveServiceAreas();
            });
        }
        
        // Map initialization functions
        function initializeMaps() {
            // Initialize the first tab (boundary) by default
            initializeMapForTab('#boundary');
        }
        
        function initializeMapForTab(tabId) {
            switch(tabId) {
                case '#boundary':
                    if (!boundaryMap) {
                        boundaryMap = createMap('boundaryMapPreview', [37.1283, -84.0836], 8);
                    }
                    break;
                case '#radius':
                    if (!radiusMap) {
                        radiusMap = createMap('radiusMapPreview', [37.1283, -84.0836], 10);
                        setupRadiusMap(radiusMap);
                    }
                    break;
                case '#polygon':
                    if (!polygonMap) {
                        polygonMap = createMap('polygonMapCanvas', [37.1283, -84.0836], 10);
                        setupPolygonMap(polygonMap);
                    }
                    break;
                case '#upload':
                    if (!uploadMap) {
                        uploadMap = createMap('uploadPreview', [37.1283, -84.0836], 8);
                    }
                    break;
            }
        }
        
        function createMap(containerId, center, zoom) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            // Create map instance
            const map = L.map(containerId, {
                center: center,
                zoom: zoom,
                zoomControl: true,
                attributionControl: true
            });
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add interaction hint for boundary map
            if (containerId === 'boundaryMapPreview') {
                const hint = L.control({position: 'topleft'});
                hint.onAdd = function() {
                    const div = L.DomUtil.create('div', 'map-hint');
                    div.innerHTML = '<i class="fas fa-info-circle"></i> Click areas to select';
                    return div;
                };
                hint.addTo(map);
            }
            
            // Force map resize after initialization
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            return map;
        }
        
        function setupRadiusMap(map) {
            let centerMarker = null;
            let radiusCircle = null;
            
            // Add click handler to set center point
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Update center input
                document.getElementById('radiusCenter').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                // Remove existing marker and circle
                if (centerMarker) map.removeLayer(centerMarker);
                if (radiusCircle) map.removeLayer(radiusCircle);
                
                // Add new marker
                centerMarker = L.marker([lat, lng]).addTo(map);
                
                // Add radius circle
                const radiusMiles = parseFloat(document.getElementById('radiusMiles').value);
                const radiusMeters = radiusMiles * 1609.34;
                radiusCircle = L.circle([lat, lng], {
                    radius: radiusMeters,
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.2,
                    weight: 2
                }).addTo(map);
                
                // Fit map to circle
                map.fitBounds(radiusCircle.getBounds());
            });
            
            // Update radius circle when slider changes
            document.getElementById('radiusMiles').addEventListener('input', function() {
                if (centerMarker && radiusCircle) {
                    const radiusMiles = parseFloat(this.value);
                    const radiusMeters = radiusMiles * 1609.34;
                    const center = centerMarker.getLatLng();
                    
                    map.removeLayer(radiusCircle);
                    radiusCircle = L.circle([center.lat, center.lng], {
                        radius: radiusMeters,
                        color: '#007bff',
                        fillColor: '#007bff',
                        fillOpacity: 0.2,
                        weight: 2
                    }).addTo(map);
                }
            });
        }
        
        function setupPolygonMap(map) {
            // Initialize drawing layer
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Initialize draw control
            drawingLayer = new L.Control.Draw({
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Error:</strong> Shape edges cannot cross!'
                        },
                        shapeOptions: {
                            color: '#007bff',
                            fillColor: '#007bff',
                            fillOpacity: 0.2,
                            weight: 2
                        }
                    },
                    circle: false,
                    rectangle: false,
                    polyline: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            map.addControl(drawingLayer);
            
            // Handle drawing events
            map.on('draw:created', function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);
                
                // Update polygon info
                updatePolygonInfo(layer);
                
                // Enable create button
                document.getElementById('createPolygonBtn').disabled = false;
            });
            
            map.on('draw:edited', function(e) {
                const layers = e.layers;
                layers.eachLayer(function(layer) {
                    updatePolygonInfo(layer);
                });
            });
            
            map.on('draw:deleted', function(e) {
                document.getElementById('createPolygonBtn').disabled = true;
                document.getElementById('vertexCount').textContent = '0';
                document.getElementById('polygonArea').textContent = '0';
            });
        }
        
        function updatePolygonInfo(layer) {
            if (layer instanceof L.Polygon) {
                const coords = layer.getLatLngs()[0];
                const vertexCount = coords.length;
                const area = L.GeometryUtil.geodesicArea(coords);
                const areaSqMiles = area * 0.000000386102; // Convert square meters to square miles
                
                document.getElementById('vertexCount').textContent = vertexCount;
                document.getElementById('polygonArea').textContent = areaSqMiles.toFixed(2);
            }
        }
        
        function cleanupMaps() {
            // Clean up map instances to prevent memory leaks
            if (boundaryMap) {
                boundaryMap.remove();
                boundaryMap = null;
            }
            if (radiusMap) {
                radiusMap.remove();
                radiusMap = null;
            }
            if (polygonMap) {
                polygonMap.remove();
                polygonMap = null;
            }
            if (uploadMap) {
                uploadMap.remove();
                uploadMap = null;
            }
            
            // Reset drawing layers
            drawingLayer = null;
            drawnItems = null;
        }
        
        // Search boundaries function
        function searchBoundaries() {
            const kind = document.getElementById('boundaryKind').value;
            const query = document.getElementById('boundarySearch').value;
            
            if (!query.trim()) {
                showToast('Please enter a search term', 'warning');
                return;
            }
            
            // Show loading
            showLoading(true);
            
            // Build search URL
            let searchUrl = `/api/areas/search/?q=${encodeURIComponent(query)}`;
            if (kind) {
                searchUrl += `&kind=${kind}`;
            }
            
            console.log('Searching boundaries with URL:', searchUrl);
            
            // Make API call to search boundaries
            fetch(searchUrl)
                .then(response => {
                    console.log('Search response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Search response data:', data);
                    showLoading(false);
                    displayBoundaryResults(data.results || []);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showLoading(false);
                    showToast('Error searching boundaries: ' + error.message, 'error');
                });
        }
        
        // Display boundary search results
        function displayBoundaryResults(results) {
            const resultsContainer = document.getElementById('boundaryResults');
            const resultsList = document.getElementById('boundaryResultsList');
            
            // Store the search results for map display
            currentSearchResults = results;
            
            if (results.length === 0) {
                resultsList.innerHTML = '<div class="text-muted small">No boundaries found matching your search.</div>';
            } else {
                resultsList.innerHTML = results.map(area => `
                    <div class="list-group-item list-group-item-action" onclick="selectBoundary(${area.id}, '${area.name}', '${area.kind}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${area.name}</h6>
                                <small class="text-muted">${area.kind}</small>
                                ${area.bounds ? `<br><small class="text-muted">Bounds: ${area.bounds.west.toFixed(3)}, ${area.bounds.south.toFixed(3)} to ${area.bounds.east.toFixed(3)}, ${area.bounds.north.toFixed(3)}</small>` : ''}
                            </div>
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); selectBoundary(${area.id}, '${area.name}', '${area.kind}')">
                                <i class="fas fa-plus"></i> Select
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }
        
        // Select a boundary
        window.selectBoundary = function(areaId, areaName, areaKind) {
            // Check if area is already selected
            const isAlreadySelected = selectedServiceAreas.some(area => area.id === areaId);
            if (isAlreadySelected) {
                showToast(`${areaName} is already selected`, 'warning');
                return;
            }
            
            // Add to selected areas
            selectedServiceAreas.push({
                id: areaId,
                name: areaName,
                type: areaKind.toLowerCase(),
                source: 'existing'
            });
            
            // Display boundary on map
            displayBoundaryOnMap(areaId);
            
            showToast(`Selected ${areaName} (${areaKind})`, 'success');
            updateServiceAreasList();
        };
        
        // Display boundary on map
        function displayBoundaryOnMap(areaId) {
            if (!boundaryMap) return;
            
            // Clear existing boundary display
            boundaryMap.eachLayer(layer => {
                if (layer instanceof L.Polygon || layer instanceof L.Marker) {
                    boundaryMap.removeLayer(layer);
                }
            });
            
            // Fetch the actual geometry for this area
            fetch(`/api/areas/${areaId}/preview/`)
                .then(response => response.json())
                .then(data => {
                    if (data.geometry) {
                        // Display the actual geometry with interactive features
                        const geoJsonLayer = L.geoJSON(data.geometry, {
                            style: {
                                color: '#007bff',
                                fillColor: '#007bff',
                                fillOpacity: 0.2,
                                weight: 2
                            }
                        }).addTo(boundaryMap);
                        
                        // Add interactive features to the geometry
                        geoJsonLayer.eachLayer(layer => {
                            // Add hover effects
                            layer.on('mouseover', function(e) {
                                this.setStyle({
                                    fillOpacity: 0.4,
                                    weight: 3
                                });
                                
                                // Show tooltip with area details
                                const tooltipContent = `
                                    <div class="text-center">
                                        <strong>${data.name}</strong><br>
                                        <small>${data.kind}</small><br>
                                        <small>Click to select</small>
                                    </div>
                                `;
                                this.bindTooltip(tooltipContent, {
                                    permanent: false,
                                    direction: 'top',
                                    className: 'custom-tooltip'
                                }).openTooltip();
                            });
                            
                            layer.on('mouseout', function(e) {
                                this.setStyle({
                                    fillOpacity: 0.2,
                                    weight: 2
                                });
                                this.closeTooltip();
                            });
                            
                            // Add click handler for selection
                            layer.on('click', function(e) {
                                // Check if this area is already selected
                                const isSelected = selectedServiceAreas.some(area => area.id === data.id);
                                
                                if (!isSelected) {
                                    // Add to selected areas
                                    selectedServiceAreas.push({
                                        id: data.id,
                                        name: data.name,
                                        type: data.kind.toLowerCase(),
                                        source: 'existing'
                                    });
                                    
                                    // Update visual style to show selection
                                    this.setStyle({
                                        color: '#28a745',
                                        fillColor: '#28a745',
                                        fillOpacity: 0.3,
                                        weight: 3
                                    });
                                    
                                    showToast(`Selected ${data.name} (${data.kind})`, 'success');
                                    updateServiceAreasList();
                                } else {
                                    // Remove from selected areas
                                    selectedServiceAreas = selectedServiceAreas.filter(area => area.id !== data.id);
                                    
                                    // Reset visual style
                                    this.setStyle({
                                        color: '#007bff',
                                        fillColor: '#007bff',
                                        fillOpacity: 0.2,
                                        weight: 2
                                    });
                                    
                                    showToast(`Deselected ${data.name}`, 'info');
                                    updateServiceAreasList();
                                }
                            });
                            
                            // Add cursor pointer to indicate clickable
                            layer.getElement().style.cursor = 'pointer';
                        });
                        
                        // Fit map to geometry bounds
                        boundaryMap.fitBounds(geoJsonLayer.getBounds());
                        
                        showToast('Boundary geometry displayed on map (click to select)', 'info');
                    } else if (data.bounds) {
                        // Fallback to bounds rectangle with interactive features
                        const bounds = [
                            [data.bounds.south, data.bounds.west],
                            [data.bounds.north, data.bounds.east]
                        ];
                        boundaryMap.fitBounds(bounds);
                        
                        const rectangle = L.rectangle(bounds, {
                            color: '#007bff',
                            fillColor: '#007bff',
                            fillOpacity: 0.2,
                            weight: 2
                        }).addTo(boundaryMap);
                        
                        // Add interactive features to rectangle
                        rectangle.on('mouseover', function(e) {
                            this.setStyle({
                                fillOpacity: 0.4,
                                weight: 3
                            });
                            
                            const tooltipContent = `
                                <div class="text-center">
                                    <strong>${data.name}</strong><br>
                                    <small>${data.kind}</small><br>
                                    <small>Click to select</small>
                                </div>
                            `;
                            this.bindTooltip(tooltipContent, {
                                permanent: false,
                                direction: 'top',
                                className: 'custom-tooltip'
                            }).openTooltip();
                        });
                        
                        rectangle.on('mouseout', function(e) {
                            this.setStyle({
                                fillOpacity: 0.2,
                                weight: 2
                            });
                            this.closeTooltip();
                        });
                        
                        rectangle.on('click', function(e) {
                            const isSelected = selectedServiceAreas.some(area => area.id === data.id);
                            
                            if (!isSelected) {
                                selectedServiceAreas.push({
                                    id: data.id,
                                    name: data.name,
                                    type: data.kind.toLowerCase(),
                                    source: 'existing'
                                });
                                
                                this.setStyle({
                                    color: '#28a745',
                                    fillColor: '#28a745',
                                    fillOpacity: 0.3,
                                    weight: 3
                                });
                                
                                showToast(`Selected ${data.name} (${data.kind})`, 'success');
                                updateServiceAreasList();
                            } else {
                                selectedServiceAreas = selectedServiceAreas.filter(area => area.id !== data.id);
                                
                                this.setStyle({
                                    color: '#007bff',
                                    fillColor: '#007bff',
                                    fillOpacity: 0.2,
                                    weight: 2
                                });
                                
                                showToast(`Deselected ${data.name}`, 'info');
                                updateServiceAreasList();
                            }
                        });
                        
                        rectangle.getElement().style.cursor = 'pointer';
                        showToast('Boundary bounds displayed on map (click to select)', 'info');
                    } else if (data.center) {
                        // Fallback to center point if no geometry or bounds
                        const center = L.latLng(data.center[0], data.center[1]);
                        const marker = L.marker(center).addTo(boundaryMap);
                        
                        // Add interactive features to marker
                        marker.bindTooltip(`
                            <div class="text-center">
                                <strong>${data.name}</strong><br>
                                <small>${data.kind}</small><br>
                                <small>Click to select</small>
                            </div>
                        `, {
                            permanent: false,
                            direction: 'top',
                            className: 'custom-tooltip'
                        });
                        
                        marker.on('click', function(e) {
                            const isSelected = selectedServiceAreas.some(area => area.id === data.id);
                            
                            if (!isSelected) {
                                selectedServiceAreas.push({
                                    id: data.id,
                                    name: data.name,
                                    type: data.kind.toLowerCase(),
                                    source: 'existing'
                                });
                                
                                this.setIcon(L.divIcon({
                                    className: 'custom-marker selected',
                                    html: '<i class="fas fa-map-marker-alt" style="color: #28a745; font-size: 24px;"></i>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 24]
                                }));
                                
                                showToast(`Selected ${data.name} (${data.kind})`, 'success');
                                updateServiceAreasList();
                            } else {
                                selectedServiceAreas = selectedServiceAreas.filter(area => area.id !== data.id);
                                
                                this.setIcon(L.divIcon({
                                    className: 'custom-marker',
                                    html: '<i class="fas fa-map-marker-alt" style="color: #007bff; font-size: 24px;"></i>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 24]
                                }));
                                
                                showToast(`Deselected ${data.name}`, 'info');
                                updateServiceAreasList();
                            }
                        });
                        
                        marker.getElement().style.cursor = 'pointer';
                        boundaryMap.setView(center, 10);
                        showToast('Boundary center displayed on map (click to select)', 'info');
                    } else {
                        // Default to Kentucky coordinates
                        const center = L.latLng(37.1283, -84.0836);
                        boundaryMap.setView(center, 8);
                        showToast('No geometry available, showing default location', 'warning');
                    }
                })
                .catch(error => {
                    console.error('Error fetching boundary geometry:', error);
                    
                    // Fallback: try to use data from search results
                    const area = currentSearchResults.find(r => r.id === areaId);
                    if (area && area.bounds) {
                        const bounds = [
                            [area.bounds.south, area.bounds.west],
                            [area.bounds.north, area.bounds.east]
                        ];
                        boundaryMap.fitBounds(bounds);
                        
                        L.rectangle(bounds, {
                            color: '#007bff',
                            fillColor: '#007bff',
                            fillOpacity: 0.2,
                            weight: 2
                        }).addTo(boundaryMap);
                        
                        showToast('Boundary displayed on map (fallback)', 'info');
                    } else {
                        showToast('Error displaying boundary on map', 'error');
                    }
                });
        }
        
        // Create radius area
        function createRadiusArea() {
            const name = document.getElementById('radiusName').value;
            const center = document.getElementById('radiusCenter').value;
            const radiusMiles = document.getElementById('radiusMiles').value;
            
            if (!name || !center) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            // Parse center coordinates
            let centerCoords;
            if (center.includes(',')) {
                // Parse coordinates
                const parts = center.split(',').map(s => s.trim());
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lng = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        centerCoords = [lat, lng];
                    }
                }
            }
            
            if (!centerCoords) {
                showToast('Please enter valid coordinates or click on the map to set center point', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Make API call to create radius area
            fetch('/api/areas/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'radius',
                    name: name,
                    center: centerCoords,
                    radius_miles: parseFloat(radiusMiles)
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.id) {
                    selectedServiceAreas.push({
                        id: data.id,
                        name: data.name,
                        type: 'radius',
                        source: 'new'
                    });
                    showToast('Radius area created successfully', 'success');
                    updateServiceAreasList();
                    document.getElementById('radiusForm').reset();
                    
                    // Clear map
                    if (radiusMap) {
                        radiusMap.eachLayer(layer => {
                            if (layer instanceof L.Marker || layer instanceof L.Circle) {
                                radiusMap.removeLayer(layer);
                            }
                        });
                    }
                } else {
                    showToast('Error creating radius area: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('Error creating radius area: ' + error.message, 'error');
            });
        }
        
        // Create polygon area
        function createPolygonArea() {
            const name = document.getElementById('polygonName').value;
            
            if (!name) {
                showToast('Please enter an area name', 'warning');
                return;
            }
            
            if (!drawnItems || drawnItems.getLayers().length === 0) {
                showToast('Please draw a polygon first', 'warning');
                return;
            }
            
            const layer = drawnItems.getLayers()[0];
            if (!(layer instanceof L.Polygon)) {
                showToast('Please draw a valid polygon', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Convert Leaflet polygon to GeoJSON
            const geojson = layer.toGeoJSON();
            
            // Make API call to create polygon area
            fetch('/api/areas/search/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    type: 'polygon',
                    name: name,
                    geometry: geojson
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.id) {
                    selectedServiceAreas.push({
                        id: data.id,
                        name: data.name,
                        type: 'polygon',
                        source: 'new'
                    });
                    showToast('Polygon area created successfully', 'success');
                    updateServiceAreasList();
                    document.getElementById('polygonForm').reset();
                    
                    // Clear the drawn polygon
                    drawnItems.clearLayers();
                    document.getElementById('createPolygonBtn').disabled = true;
                    document.getElementById('vertexCount').textContent = '0';
                    document.getElementById('polygonArea').textContent = '0';
                } else {
                    showToast('Error creating polygon area: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('Error creating polygon area: ' + error.message, 'error');
            });
        }
        
        // Upload GeoJSON
        function uploadGeoJSON() {
            const name = document.getElementById('uploadName').value;
            const fileInput = document.getElementById('geojsonFile');
            
            if (!name) {
                showToast('Please enter an area name', 'warning');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Please select a GeoJSON file', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.json') && !file.name.toLowerCase().endsWith('.geojson')) {
                showToast('Please select a valid GeoJSON file (.json or .geojson)', 'warning');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB', 'warning');
                return;
            }
            
            showLoading(true);
            
            // Read and validate GeoJSON
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const geojson = JSON.parse(e.target.result);
                    
                    // Basic GeoJSON validation
                    if (!geojson.type || !geojson.geometry) {
                        throw new Error('Invalid GeoJSON structure');
                    }
                    
                    if (geojson.geometry.type !== 'Polygon' && geojson.geometry.type !== 'MultiPolygon') {
                        throw new Error('Only Polygon and MultiPolygon geometries are supported');
                    }
                    
                    // Display preview on map
                    if (uploadMap) {
                        // Clear existing layers
                        uploadMap.eachLayer(layer => {
                            if (layer instanceof L.Polygon || layer instanceof L.Marker) {
                                uploadMap.removeLayer(layer);
                            }
                        });
                        
                        // Add GeoJSON to map
                        L.geoJSON(geojson, {
                            style: {
                                color: '#007bff',
                                fillColor: '#007bff',
                                fillOpacity: 0.2,
                                weight: 2
                            }
                        }).addTo(uploadMap);
                        
                        // Fit map to geometry
                        const layer = L.geoJSON(geojson);
                        uploadMap.fitBounds(layer.getBounds());
                    }
                    
                    // Create the area
                    fetch('/api/areas/search/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            type: 'polygon',
                            name: name,
                            geometry: geojson
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);
                        if (data.id) {
                            selectedServiceAreas.push({
                                id: data.id,
                                name: data.name,
                                type: 'polygon',
                                source: 'upload'
                            });
                            showToast('GeoJSON uploaded and area created successfully', 'success');
                            updateServiceAreasList();
                            document.getElementById('uploadForm').reset();
                            
                            // Clear map
                            if (uploadMap) {
                                uploadMap.eachLayer(layer => {
                                    if (layer instanceof L.Polygon || layer instanceof L.Marker) {
                                        uploadMap.removeLayer(layer);
                                    }
                                });
                            }
                        } else {
                            showToast('Error creating area: ' + (data.error || 'Unknown error'), 'error');
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showToast('Error creating area: ' + error.message, 'error');
                    });
                    
                } catch (error) {
                    showLoading(false);
                    showToast('Invalid GeoJSON file: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showLoading(false);
                showToast('Error reading file', 'error');
            };
            
            reader.readAsText(file);
        }
        
        // Save service areas to resource
        function saveServiceAreas() {
            if (selectedServiceAreas.length === 0) {
                showToast('No service areas selected to save', 'warning');
                return;
            }
            
            // Get the resource ID from the current page
            const resourceId = getResourceId();
            if (!resourceId) {
                showToast('Could not determine resource ID', 'error');
                return;
            }
            
            showLoading(true);
            
            // Prepare the data to send
            const coverageAreaIds = selectedServiceAreas.map(area => area.id);
            const requestData = {
                action: 'attach',
                coverage_area_ids: coverageAreaIds,
                notes: 'Added via Service Area Manager'
            };
            
            // Make API call to save areas
            fetch(`/api/resources/${resourceId}/areas/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (data.success) {
                    showToast(`Successfully saved ${data.attached_count} service areas to resource`, 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('serviceAreaModal'));
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    const errorMessage = data.errors && data.errors.length > 0 
                        ? data.errors.join(', ') 
                        : (data.error || 'Unknown error occurred');
                    showToast('Error saving service areas: ' + errorMessage, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showToast('Error saving service areas: ' + error.message, 'error');
            });
        }
        

        
        // Load initial service areas data from context
        function loadInitialServiceAreas() {
            const initialDataInput = document.getElementById('initialServiceAreasData');
            if (initialDataInput && initialDataInput.value) {
                try {
                    const initialData = JSON.parse(initialDataInput.value);
                    if (initialData && initialData.length > 0) {
                        selectedServiceAreas = initialData;
                        updateServiceAreasList();
                        
                        // Update the status badge to show configured
                        const statusBadge = document.getElementById('serviceAreasStatus');
                        if (statusBadge) {
                            statusBadge.innerHTML = `<span class="badge bg-success">Configured (${initialData.length})</span>`;
                        }
                    }
                } catch (error) {
                    console.error('Error parsing initial service areas data:', error);
                }
            }
        }

        // Update modal context for edit mode
        function updateModalContext() {
            const isEditMode = document.querySelector('input[name="is_edit"]') || 
                              window.location.pathname.includes('/edit/');
            
            const modalTitle = document.getElementById('modalTitle');
            const editIndicator = document.getElementById('editModeIndicator');
            
            if (isEditMode || window.location.pathname.includes('/edit/')) {
                if (modalTitle) modalTitle.textContent = 'Edit Service Areas';
                if (editIndicator) editIndicator.style.display = 'inline';
                
                // Update save button text
                const saveBtn = document.getElementById('saveServiceAreasBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Update Service Areas';
                }
            } else {
                if (modalTitle) modalTitle.textContent = 'Service Area Manager';
                if (editIndicator) editIndicator.style.display = 'none';
                
                // Update save button text
                const saveBtn = document.getElementById('saveServiceAreasBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Service Areas';
                }
            }
        }

        // Load existing service areas when modal opens
        function loadExistingServiceAreas() {
            const resourceId = getResourceId();
            if (!resourceId) {
                return;
            }
            
            // Check if we already have service areas loaded
            if (selectedServiceAreas.length > 0) {
                console.log('Service areas already loaded, skipping API call');
                // Display existing areas on the map
                displayExistingAreasOnMap(selectedServiceAreas.map(area => ({
                    id: area.id,
                    name: area.name,
                    kind: area.type.toUpperCase(),
                    bounds: null // We'll get bounds from the preview API
                })));
                return;
            }
            
            showLoading(true);
            
            fetch(`/api/resources/${resourceId}/areas/`)
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (data.coverage_areas && data.coverage_areas.length > 0) {
                    // Convert to the format expected by selectedServiceAreas
                    selectedServiceAreas = data.coverage_areas.map(area => ({
                        id: area.id,
                        name: area.name,
                        type: area.kind.toLowerCase(),
                        source: 'existing',
                        attached_at: area.attached_at,
                        attached_by: area.attached_by
                    }));
                    
                    updateServiceAreasList();
                    showToast(`Loaded ${data.coverage_areas.length} existing service areas`, 'info');
                    
                    // Display all existing areas on the map
                    displayExistingAreasOnMap(data.coverage_areas);
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error loading existing service areas:', error);
                // Don't show error toast for this - it's not critical
            });
        }
        
        // Display existing service areas on the map
        function displayExistingAreasOnMap(areas) {
            if (!boundaryMap) return;
            
            // Clear existing display
            boundaryMap.eachLayer(layer => {
                if (layer instanceof L.Polygon || layer instanceof L.Marker) {
                    boundaryMap.removeLayer(layer);
                }
            });
            
            // Display each area with interactive features
            areas.forEach(area => {
                if (area.bounds) {
                    const bounds = [
                        [area.bounds.south, area.bounds.west],
                        [area.bounds.north, area.bounds.east]
                    ];
                    
                    // Add a rectangle for each area with different colors
                    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
                    const color = colors[area.id % colors.length];
                    
                    const rectangle = L.rectangle(bounds, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.2,
                        weight: 2
                    }).addTo(boundaryMap);
                    
                    // Add interactive features
                    rectangle.on('mouseover', function(e) {
                        this.setStyle({
                            fillOpacity: 0.4,
                            weight: 3
                        });
                        
                        const tooltipContent = `
                            <div class="text-center">
                                <strong>${area.name}</strong><br>
                                <small>${area.kind} • Existing</small><br>
                                <small>Click to remove</small>
                            </div>
                        `;
                        this.bindTooltip(tooltipContent, {
                            permanent: false,
                            direction: 'top',
                            className: 'custom-tooltip'
                        }).openTooltip();
                    });
                    
                    rectangle.on('mouseout', function(e) {
                        this.setStyle({
                            fillOpacity: 0.2,
                            weight: 2
                        });
                        this.closeTooltip();
                    });
                    
                    rectangle.on('click', function(e) {
                        // Remove from selected areas
                        selectedServiceAreas = selectedServiceAreas.filter(selectedArea => selectedArea.id !== area.id);
                        
                        // Remove from map
                        boundaryMap.removeLayer(this);
                        
                        showToast(`Removed ${area.name} from selection`, 'info');
                        updateServiceAreasList();
                    });
                    
                    rectangle.getElement().style.cursor = 'pointer';
                } else {
                    // For areas without bounds, just show a message
                    console.log(`Area ${area.name} has no bounds data`);
                }
            });
            
            // Fit map to show all areas
            if (areas.length > 0 && areas[0].bounds) {
                const allBounds = areas.map(area => [
                    [area.bounds.south, area.bounds.west],
                    [area.bounds.north, area.bounds.east]
                ]);
                
                // Create a combined bounds object
                let combinedBounds = L.latLngBounds(allBounds[0]);
                allBounds.forEach(bounds => {
                    combinedBounds.extend(bounds);
                });
                
                boundaryMap.fitBounds(combinedBounds);
            }
        }
        
        // Update service areas list display
        function updateServiceAreasList() {
            const listContainer = document.getElementById('serviceAreasList');
            const countBadge = document.getElementById('serviceAreasCount');
            const statusBadge = document.getElementById('serviceAreasStatus');
            const summaryDiv = document.getElementById('serviceAreasSummary');
            const searchImpactText = document.getElementById('searchImpactText');
            
            // Update count badge
            if (countBadge) {
                countBadge.textContent = selectedServiceAreas.length;
                countBadge.className = selectedServiceAreas.length > 0 ? 'badge bg-success ms-2' : 'badge bg-secondary ms-2';
            }
            
            // Update status badge
            if (statusBadge) {
                if (selectedServiceAreas.length === 0) {
                    statusBadge.innerHTML = '<span class="badge bg-warning">Not configured</span>';
                } else if (selectedServiceAreas.length === 1) {
                    statusBadge.innerHTML = '<span class="badge bg-info">1 area configured</span>';
                } else {
                    statusBadge.innerHTML = `<span class="badge bg-success">${selectedServiceAreas.length} areas configured</span>`;
                }
            }
            
            // Update search impact text
            if (searchImpactText) {
                if (selectedServiceAreas.length === 0) {
                    searchImpactText.textContent = 'No service areas configured.';
                } else if (selectedServiceAreas.length === 1) {
                    const area = selectedServiceAreas[0];
                    searchImpactText.textContent = `Users searching in ${area.name} will find your resource.`;
                } else {
                    const areaNames = selectedServiceAreas.slice(0, 2).map(a => a.name).join(', ');
                    const remaining = selectedServiceAreas.length - 2;
                    if (remaining > 0) {
                        searchImpactText.textContent = `Users searching in ${areaNames} and ${remaining} other areas will find your resource.`;
                    } else {
                        searchImpactText.textContent = `Users searching in ${areaNames} will find your resource.`;
                    }
                }
            }
            
            // Show/hide summary
            if (summaryDiv) {
                summaryDiv.style.display = selectedServiceAreas.length > 0 ? 'block' : 'none';
            }
            
            if (selectedServiceAreas.length === 0) {
                listContainer.innerHTML = '<div class="text-muted small p-3 text-center">\n' +
                    '                                        <i class="fas fa-map-marker-alt fa-2x mb-2 text-muted"></i>\n' +
                    '                                        <div>No service areas defined yet.</div>\n' +
                    '                                        <div class="small">Click "Configure Service Areas" to get started.</div>\n' +
                    '                                    </div>';
            } else {
                listContainer.innerHTML = selectedServiceAreas.map(area => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                <div>
                                    <h6 class="mb-1">${area.name || 'Area ' + area.id}</h6>
                                    <small class="text-muted">
                                        <span class="badge bg-light text-dark me-1">${area.type}</span>
                                        ${area.source === 'new' ? 'New' : 'Existing'}
                                        ${area.attached_at ? `• Added ${new Date(area.attached_at).toLocaleDateString()}` : ''}
                                        ${area.attached_by ? `• by ${area.attached_by}` : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-info btn-sm me-1" onclick="previewServiceArea(${area.id})" title="Preview this area on map">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="removeServiceArea(${area.id})" title="Remove this service area">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Remove service area
        window.removeServiceArea = function(areaId) {
            selectedServiceAreas = selectedServiceAreas.filter(area => area.id !== areaId);
            updateServiceAreasList();
            showToast('Service area removed', 'success');
        };

        // Preview service area on map
        window.previewServiceArea = function(areaId) {
            const area = selectedServiceAreas.find(a => a.id === areaId);
            if (!area) {
                showToast('Area not found', 'error');
                return;
            }
            
            // Switch to boundary tab and display the area
            const boundaryTab = document.getElementById('boundary-tab');
            if (boundaryTab) {
                boundaryTab.click();
            }
            
            // Display the area on the map
            setTimeout(() => {
                displayBoundaryOnMap(areaId);
                showToast(`Previewing ${area.name}`, 'info');
            }, 100);
        };

        // Clear all service areas
        window.clearAllServiceAreas = function() {
            if (confirm('Are you sure you want to clear all service areas? This action cannot be undone.')) {
                selectedServiceAreas = [];
                updateServiceAreasList();
                showToast('All service areas cleared', 'info');
            }
        };

        // Show search preview
        window.showSearchPreview = function() {
            if (selectedServiceAreas.length === 0) {
                showToast('No service areas configured to preview', 'warning');
                return;
            }
            
            const areaNames = selectedServiceAreas.map(a => a.name).join(', ');
            const message = `Search Preview: Your resource will appear when users search for services in: ${areaNames}`;
            
            // Create a modal to show the preview
            const previewModal = document.createElement('div');
            previewModal.className = 'modal fade';
            previewModal.id = 'searchPreviewModal';
            previewModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-search me-2"></i>Search Preview
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>How your resource will appear in searches:</strong>
                            </div>
                            <div class="mb-3">
                                <h6>Service Areas:</h6>
                                <ul class="list-group">
                                    ${selectedServiceAreas.map(area => `
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${area.name}</strong>
                                                <br><small class="text-muted">${area.type} • ${area.source === 'new' ? 'New' : 'Existing'}</small>
                                            </div>
                                            <span class="badge bg-primary">${area.type.toUpperCase()}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Search Impact:</strong> Users searching for services in these areas will see your resource in their results.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            const modal = new bootstrap.Modal(previewModal);
            modal.show();
            
            // Clean up modal after it's hidden
            previewModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(previewModal);
            });
        };

        // Handle form submission to include service areas
        const resourceForm = document.querySelector('form[method="post"]');
        if (resourceForm) {
            resourceForm.addEventListener('submit', function(e) {
                // Always add service areas to form data before submission
                // This ensures that even empty service areas are processed (to clear existing associations)
                
                // Remove any existing service_areas input to avoid duplicates
                const existingInput = resourceForm.querySelector('input[name="service_areas"]');
                if (existingInput) {
                    existingInput.remove();
                }
                
                // Create hidden input for service areas
                const serviceAreasInput = document.createElement('input');
                serviceAreasInput.type = 'hidden';
                serviceAreasInput.name = 'service_areas';
                
                if (selectedServiceAreas.length > 0) {
                    serviceAreasInput.value = JSON.stringify(selectedServiceAreas.map(area => area.id));
                } else {
                    serviceAreasInput.value = '[]'; // Empty array to clear existing associations
                }
                
                resourceForm.appendChild(serviceAreasInput);
            });
        }
        
        

        

    }
</script>
{% endblock %}
