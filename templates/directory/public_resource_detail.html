{% extends "base.html" %}

{% block title %}{{ resource.name }} - Homeless Resource Directory{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'directory:public_home' %}">Home</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'directory:public_resource_list' %}">Resources</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ resource.name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Resource Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h2 mb-2">{{ resource.name }}</h1>
                            {% if resource.category %}
                            <p class="text-muted mb-2">
                                <i class="fas fa-tag"></i> {{ resource.category.name }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-2">
                            {% if resource.is_emergency_service %}
                            <span class="badge bg-danger fs-6" title="Emergency Service">
                                <i class="fas fa-exclamation-triangle"></i> Emergency
                            </span>
                            {% endif %}
                            {% if resource.is_24_hour_service %}
                            <span class="badge bg-success fs-6" title="24-Hour Service">
                                <i class="fas fa-clock"></i> 24-Hour
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    {% if resource.description %}
                    <div class="mb-4">
                        <h5>Description</h5>
                        <p class="lead">{{ resource.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Service Types -->
                    {% if resource.service_types.exists %}
                    <div class="mb-4">
                        <h5>Services Offered</h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for service_type in resource.service_types.all %}
                            <span class="badge bg-primary">{{ service_type.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-address-book"></i> Contact Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if resource.phone %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-phone text-primary"></i> Phone</h6>
                            <p class="mb-0">
                                <a href="tel:{{ resource.phone }}" class="text-decoration-none">{{ resource.phone }}</a>
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if resource.email %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-envelope text-primary"></i> Email</h6>
                            <p class="mb-0">
                                <a href="mailto:{{ resource.email }}" class="text-decoration-none">{{ resource.email }}</a>
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if resource.website %}
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-globe text-primary"></i> Website</h6>
                            <p class="mb-0">
                                <a href="{{ resource.website }}" target="_blank" class="text-decoration-none">{{ resource.website }}</a>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Location -->
            {% if resource.address1 or resource.city or resource.state %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Location</h5>
                </div>
                <div class="card-body">
                    <address class="mb-0">
                        {% if resource.address1 %}{{ resource.address1 }}<br>{% endif %}
                        {% if resource.address2 %}{{ resource.address2 }}<br>{% endif %}
                        {% if resource.city or resource.state or resource.postal_code %}
                            {% if resource.city %}{{ resource.city }}{% endif %}{% if resource.city and resource.state %}, {% endif %}
                            {% if resource.state %}{{ resource.state }}{% endif %}
                            {% if resource.postal_code %} {{ resource.postal_code }}{% endif %}
                        {% endif %}
                        {% if resource.county %}<br>{{ resource.county }} County{% endif %}
                    </address>
                </div>
            </div>
            {% endif %}

            <!-- Coverage Areas -->
            {% if resource.coverage_areas.exists %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marked-alt"></i> Service Areas
                        <span class="badge bg-info ms-2">{{ resource.coverage_areas.count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Coverage Areas List -->
                    <div class="mb-3">
                        <h6>Coverage Areas:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for area in resource.coverage_areas.all %}
                                <span class="badge bg-primary">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ area.name }}
                                    {% if area.kind %}
                                        <small class="ms-1">({{ area.kind }})</small>
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Map Visualization -->
                    <div class="mb-3">
                        <h6>Service Area Map:</h6>
                        <div id="coverage-map" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 4px;"></div>
                    </div>
                    
                    <!-- Coverage Area Details -->
                    <div>
                        <h6>Coverage Details:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Area Name</th>
                                        <th>Type</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for area in resource.coverage_areas.all %}
                                    <tr>
                                        <td>{{ area.name }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ area.kind }}</span>
                                        </td>
                                        <td>
                                            {% if area.ext_ids %}
                                                <small class="text-muted">
                                                    {% for key, value in area.ext_ids.items %}
                                                        {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">No additional details</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Location-Based Eligibility -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-location-arrow"></i> Location Eligibility
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Check if this resource serves your area:</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="eligibility-address" class="form-control" placeholder="Enter your address">
                                <button class="btn btn-outline-primary" type="button" onclick="checkEligibility()">
                                    <i class="fas fa-search"></i> Check
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="eligibility-result" class="mt-3">
                                <p class="text-muted">Enter an address to check if this resource serves your area.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operational Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock"></i> Operational Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if resource.hours_of_operation %}
                        <div class="col-md-6 mb-3">
                            <h6>Hours of Operation</h6>
                            <p class="mb-0">{{ resource.hours_of_operation }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.capacity %}
                        <div class="col-md-6 mb-3">
                            <h6>Capacity</h6>
                            <p class="mb-0">{{ resource.capacity }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.eligibility_requirements %}
                        <div class="col-12 mb-3">
                            <h6>Eligibility Requirements</h6>
                            <p class="mb-0">{{ resource.eligibility_requirements }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.populations_served %}
                        <div class="col-md-6 mb-3">
                            <h6>Populations Served</h6>
                            <p class="mb-0">{{ resource.populations_served }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.languages_available %}
                        <div class="col-md-6 mb-3">
                            <h6>Languages Available</h6>
                            <p class="mb-0">{{ resource.languages_available }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.insurance_accepted %}
                        <div class="col-md-6 mb-3">
                            <h6>Insurance Accepted</h6>
                            <p class="mb-0">{{ resource.insurance_accepted }}</p>
                        </div>
                        {% endif %}
                        
                        {% if resource.cost_information %}
                        <div class="col-md-6 mb-3">
                            <h6>Cost Information</h6>
                            <p class="mb-0">{{ resource.cost_information }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if resource.phone %}
                        <a href="tel:{{ resource.phone }}" class="btn btn-primary">
                            <i class="fas fa-phone"></i> Call Now
                        </a>
                        {% endif %}
                        
                        {% if resource.website %}
                        <a href="{{ resource.website }}" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Visit Website
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'directory:public_resource_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-list"></i> View All Resources
                        </a>
                    </div>
                </div>
            </div>

            <!-- Related Resources -->
            {% if related_resources %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Related Resources</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for related in related_resources %}
                        <a href="{% url 'directory:public_resource_detail' related.pk %}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ related.name }}</h6>
                                <div class="d-flex gap-1">
                                    {% if related.is_emergency_service %}
                                    <span class="badge bg-danger" title="Emergency Service">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                    {% endif %}
                                    {% if related.is_24_hour_service %}
                                    <span class="badge bg-success" title="24-Hour Service">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if related.city and related.state %}
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> {{ related.city }}, {{ related.state }}
                            </small>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Verification Info -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Information Quality</h5>
                </div>
                <div class="card-body">
                    {% if resource.last_verified_at %}
                    <p class="small text-muted mb-1">
                        <i class="fas fa-check-circle text-success"></i> 
                        Last verified: {{ resource.last_verified_at|date:"M j, Y" }}
                    </p>
                    {% endif %}
                    
                    {% if resource.source %}
                    <p class="small text-muted mb-0">
                        <i class="fas fa-source"></i> 
                        Source: {{ resource.source }}
                    </p>
                    {% endif %}
                    
                    <hr>
                    
                    <p class="small text-muted mb-0">
                        <i class="fas fa-info-circle"></i> 
                        This information is maintained by community partners. 
                        Please verify details before visiting.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Coverage Area Map Visualization
    {% if resource.coverage_areas.exists %}
    document.addEventListener('DOMContentLoaded', function() {
        const mapContainer = document.getElementById('coverage-map');
        if (mapContainer) {
            // Initialize map with Leaflet
            const map = L.map('coverage-map').setView([37.7749, -122.4194], 10);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Load coverage areas from API
            fetch('{% url "directory:api_resource_areas" resource.pk %}')
                .then(response => response.json())
                .then(data => {
                    if (data.coverage_areas && data.coverage_areas.length > 0) {
                        let bounds = [];
                        let loadedAreas = 0;
                        
                        data.coverage_areas.forEach(area => {
                            // Fetch actual geometry for each area
                            fetch(`/api/areas/${area.id}/preview/`)
                                .then(response => response.json())
                                .then(areaData => {
                                    if (areaData.geometry) {
                                        // Display actual geometry using GeoJSON
                                        const geoJsonLayer = L.geoJSON(areaData.geometry, {
                                            style: {
                                                color: '#007bff',
                                                weight: 2,
                                                fillColor: '#007bff',
                                                fillOpacity: 0.2
                                            }
                                        }).addTo(map);
                                        
                                        // Add popup with area details
                                        geoJsonLayer.eachLayer(layer => {
                                            layer.bindPopup(`
                                                <strong>${area.name}</strong><br>
                                                Type: ${area.kind}<br>
                                                <small class="text-muted">Click to view details</small>
                                            `);
                                        });
                                        
                                        // Add to bounds for map fitting
                                        if (areaData.bounds) {
                                            bounds.push([
                                                [areaData.bounds.south, areaData.bounds.west],
                                                [areaData.bounds.north, areaData.bounds.east]
                                            ]);
                                        }
                                    } else if (area.bounds) {
                                        // Fallback to rectangle if no geometry
                                        const rectangle = L.rectangle([
                                            [area.bounds.south, area.bounds.west],
                                            [area.bounds.north, area.bounds.east]
                                        ], {
                                            color: '#007bff',
                                            weight: 2,
                                            fillColor: '#007bff',
                                            fillOpacity: 0.2
                                        }).addTo(map);
                                        
                                        rectangle.bindPopup(`
                                            <strong>${area.name}</strong><br>
                                            Type: ${area.kind}<br>
                                            <small class="text-muted">Click to view details</small>
                                        `);
                                        
                                        bounds.push([
                                            [area.bounds.south, area.bounds.west],
                                            [area.bounds.north, area.bounds.east]
                                        ]);
                                    }
                                    
                                    loadedAreas++;
                                    
                                    // Fit map when all areas are loaded
                                    if (loadedAreas === data.coverage_areas.length && bounds.length > 0) {
                                        map.fitBounds(bounds);
                                    }
                                })
                                .catch(error => {
                                    console.error(`Error loading geometry for area ${area.id}:`, error);
                                    loadedAreas++;
                                    
                                    // Try to fit map even if some areas failed
                                    if (loadedAreas === data.coverage_areas.length && bounds.length > 0) {
                                        map.fitBounds(bounds);
                                    }
                                });
                        });
                    } else {
                        // Show message if no coverage areas
                        mapContainer.innerHTML = '<div class="text-center text-muted p-4">No coverage area data available for map display</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading coverage areas:', error);
                    mapContainer.innerHTML = '<div class="text-center text-danger p-4">Error loading coverage area data</div>';
                });
        }
    });
    {% endif %}

                    // Enhanced Location Eligibility Check
                function checkEligibility() {
                    const address = document.getElementById('eligibility-address').value.trim();
                    const resultDiv = document.getElementById('eligibility-result');
                    
                    if (!address) {
                        resultDiv.innerHTML = '<div class="alert alert-warning">Please enter an address to check eligibility.</div>';
                        return;
                    }
                    
                    resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Checking eligibility...</div>';
                    
                    // First, geocode the address to get coordinates
                    fetch(`{% url "directory:api_location_search" %}?address=${encodeURIComponent(address)}&radius_miles=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.location && data.location.coordinates) {
                                const [lat, lon] = data.location.coordinates;
                                
                                // Now check specific resource eligibility with coordinates
                                return fetch(`{% url "directory:api_resource_eligibility" resource.pk %}?lat=${lat}&lon=${lon}&address=${encodeURIComponent(address)}`);
                            } else {
                                throw new Error('Could not geocode address');
                            }
                        })
                        .then(response => response.json())
                        .then(eligibilityData => {
                            if (eligibilityData.error) {
                                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${eligibilityData.error}</div>`;
                                return;
                            }
                            
                            const { serves_location, distance_miles, eligibility_reason, coverage_areas, query_address } = eligibilityData;
                            
                            let resultHtml = '';
                            
                            if (serves_location) {
                                resultHtml = `
                                    <div class="alert alert-success">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                                            <div>
                                                <h6 class="alert-heading">✅ Serves Your Area!</h6>
                                                <p class="mb-2">${eligibility_reason}</p>
                                                ${distance_miles ? `<p class="mb-1"><strong>Distance:</strong> ${distance_miles} miles</p>` : ''}
                                                <small class="text-muted">Address: ${query_address || address}</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                resultHtml = `
                                    <div class="alert alert-warning">
                                        <div class="d-flex align-items-start">
                                            <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                                            <div>
                                                <h6 class="alert-heading">⚠️ May Not Serve Your Area</h6>
                                                <p class="mb-2">${eligibility_reason}</p>
                                                ${distance_miles ? `<p class="mb-1"><strong>Distance:</strong> ${distance_miles} miles</p>` : ''}
                                                <small class="text-muted">Address: ${query_address || address}</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Add coverage area details if available
                            if (coverage_areas && coverage_areas.length > 0) {
                                resultHtml += `
                                    <div class="mt-3">
                                        <h6>Coverage Area Details:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Area Name</th>
                                                        <th>Type</th>
                                                        <th>Distance</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${coverage_areas.map(area => `
                                                        <tr>
                                                            <td>${area.name}</td>
                                                            <td><span class="badge bg-secondary">${area.kind}</span></td>
                                                            <td>${area.distance_miles} miles</td>
                                                            <td>
                                                                ${area.contains_location ? 
                                                                    '<span class="badge bg-success">Serves</span>' : 
                                                                    '<span class="badge bg-light text-dark">Nearby</span>'
                                                                }
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            resultDiv.innerHTML = resultHtml;
                        })
                        .catch(error => {
                            console.error('Error checking eligibility:', error);
                            resultDiv.innerHTML = '<div class="alert alert-danger">Error checking eligibility. Please try again.</div>';
                        });
                }
</script>
{% endblock %}
