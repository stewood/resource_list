{% extends "base.html" %}
{% load directory_extras %}

{% block title %}Resources - Homeless Resource Directory{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card filter-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="resetFilters">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                <div class="card-body" id="filterContent">
                    <form method="get" id="filter-form">
                        <!-- Active Filters Display -->
                        <div class="active-filters mb-3" id="activeFiltersContainer" style="display: none;">
                            <label class="form-label fw-bold mb-2">
                                <i class="fas fa-tags me-1"></i>Active Filters
                            </label>
                            <div id="activeFilters" class="d-flex flex-wrap gap-1">
                                <!-- Active filters will be populated here -->
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="search-container mb-3">
                            <label for="search" class="form-label fw-bold">
                                <i class="fas fa-search me-1"></i>Search
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search" name="q" 
                                       value="{{ search_query }}" placeholder="Search resources...">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Filters -->
                        <div class="quick-filters mb-3">
                            <label class="form-label fw-bold mb-2">
                                <i class="fas fa-bolt me-1"></i>Quick Links
                            </label>
                            <div class="d-flex flex-column gap-2">
                                <button type="button" class="btn btn-outline-danger quick-filter-btn" data-filter="category" data-value="hotlines">
                                    <i class="fas fa-phone-alt me-1"></i>Hotlines & Crisis
                                </button>
                                <button type="button" class="btn btn-outline-primary quick-filter-btn" data-filter="category" data-value="housing">
                                    <i class="fas fa-house-user me-1"></i>Housing & Shelter
                                </button>
                                <button type="button" class="btn btn-outline-success quick-filter-btn" data-filter="category" data-value="medical">
                                    <i class="fas fa-stethoscope me-1"></i>Medical & Health
                                </button>
                                <button type="button" class="btn btn-outline-info quick-filter-btn" data-filter="category" data-value="mental_health">
                                    <i class="fas fa-head-side-virus me-1"></i>Mental Health
                                </button>
                                <button type="button" class="btn btn-outline-warning quick-filter-btn" data-filter="category" data-value="food_assistance">
                                    <i class="fas fa-hamburger me-1"></i>Food Assistance
                                </button>
                                <button type="button" class="btn btn-outline-danger quick-filter-btn" data-filter="category" data-value="emergency_services">
                                    <i class="fas fa-shield-alt me-1"></i>Emergency Services
                                </button>
                                <button type="button" class="btn btn-outline-info quick-filter-btn" data-filter="category" data-value="legal">
                                    <i class="fas fa-balance-scale me-1"></i>Legal Services
                                </button>
                                <button type="button" class="btn btn-outline-secondary quick-filter-btn" data-filter="category" data-value="transportation">
                                    <i class="fas fa-bus me-1"></i>Transportation
                                </button>
                            </div>
                        </div>

                        <!-- Category Filter -->
                        <div class="filter-group mb-3">
                            <label for="category" class="form-label fw-bold">
                                <i class="fas fa-tag me-1"></i>Category
                            </label>
                            <select class="form-select" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Service Type Filter -->
                        <div class="filter-group mb-3">
                            <label for="service_type" class="form-label fw-bold">
                                <i class="fas fa-cogs me-1"></i>Service Type
                            </label>
                            <select class="form-select" id="service_type" name="service_type">
                                <option value="">All Service Types</option>
                                {% for service_type in service_types %}
                                <option value="{{ service_type.id }}" {% if service_type_filter == service_type.id|stringformat:"s" %}selected{% endif %}>
                                    {{ service_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Location Filters -->
                        <div class="filter-section mb-3">
                            <h6 class="filter-section-title">
                                <i class="fas fa-map-marker-alt me-1"></i>Location
                            </h6>
                            <div class="filter-group mb-2">
                                <label for="city" class="form-label">City</label>
                                <select class="form-select" id="city" name="city">
                                    <option value="">All Cities</option>
                                    {% for city in cities %}
                                    <option value="{{ city }}" {% if city_filter == city %}selected{% endif %}>
                                        {{ city }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group mb-2">
                                <label for="state" class="form-label">State</label>
                                <select class="form-select" id="state" name="state">
                                    <option value="">All States</option>
                                    {% for state in states %}
                                    <option value="{{ state }}" {% if state_filter == state %}selected{% endif %}>
                                        {{ state }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Service Availability -->
                        <div class="filter-section mb-3">
                            <h6 class="filter-section-title">
                                <i class="fas fa-clock me-1"></i>Service Availability
                            </h6>
                            <div class="filter-group">
                                <label for="24hour" class="form-label">24-Hour Services</label>
                                <select class="form-select" id="24hour" name="24hour">
                                    <option value="">All Services</option>
                                    <option value="true" {% if '24hour' in request.GET and request.GET.24hour == 'true' %}selected{% endif %}>24-Hour Only</option>
                                    <option value="false" {% if '24hour' in request.GET and request.GET.24hour == 'false' %}selected{% endif %}>Non-24-Hour Only</option>
                                </select>
                            </div>
                        </div>

                        <!-- Sort Options -->
                        <div class="filter-section mb-3">
                            <h6 class="filter-section-title">
                                <i class="fas fa-sort me-1"></i>Sort Options
                            </h6>
                            <div class="filter-group">
                                <label for="sort" class="form-label">Sort By</label>
                                <select class="form-select" id="sort" name="sort">
                                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name A-Z</option>
                                    <option value="city" {% if sort_by == 'city' %}selected{% endif %}>City A-Z</option>
                                    <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Category</option>
                                    <option value="emergency" {% if sort_by == 'emergency' %}selected{% endif %}>Emergency First</option>
                                </select>
                            </div>
                        </div>

                        <!-- Apply/Clear Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                            <a href="{% url 'directory:public_resource_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear All
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Resources</h1>
                    {% if page_obj %}
                        <p class="text-muted mb-0">Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} resources</p>
                    {% endif %}
                </div>
                <a href="{% url 'directory:public_home' %}" class="btn btn-outline-primary">
                    <i class="fas fa-home me-1"></i>Back to Home
                </a>
            </div>

            <!-- Resource Grid -->
            {% if page_obj %}
            <div class="row g-4">
                {% for resource in page_obj %}
                <div class="col-md-6">
                    <div class="card h-100 resource-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">
                                    <a href="{% url 'directory:public_resource_detail' resource.pk %}" class="text-decoration-none">
                                        {{ resource.name }}
                                    </a>
                                </h5>
                                <div class="d-flex gap-1">
                                    {% if resource.is_emergency_service %}
                                    <span class="badge bg-danger" title="Emergency Service">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                    {% endif %}
                                    {% if resource.is_24_hour_service %}
                                    <span class="badge bg-success" title="24-Hour Service">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if resource.category %}
                            <p class="text-muted small mb-2">
                                <i class="fas fa-tag"></i> {{ resource.category.name }}
                            </p>
                            {% endif %}
                            
                            {% if resource.description %}
                            <p class="card-text">{{ resource.description|truncatewords:20 }}</p>
                            {% endif %}
                            
                            {% if resource.city and resource.state %}
                            <p class="text-muted small mb-2">
                                <i class="fas fa-map-marker-alt"></i> {{ resource.city }}, {{ resource.state }}
                            </p>
                            {% endif %}
                            
                            {% if resource.phone %}
                            <p class="text-muted small mb-3">
                                <i class="fas fa-phone"></i> {{ resource.phone }}
                            </p>
                            {% endif %}
                            
                            <div class="mt-auto">
                                <a href="{% url 'directory:public_resource_detail' resource.pk %}" class="btn btn-primary btn-sm">
                                    View Details <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Resource pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No resources found</h5>
                <p class="text-muted">Try adjusting your search criteria.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('filter-form');
        const resetBtn = document.getElementById('resetFilters');
        const activeFiltersContainer = document.getElementById('activeFiltersContainer');
        const activeFilters = document.getElementById('activeFilters');
        
        // Reset filters
        resetBtn.addEventListener('click', function() {
            const inputs = filterForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type === 'text') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                }
            });
            
            activeFilters.innerHTML = '';
            activeFiltersContainer.style.display = 'none';
            
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            filterForm.submit();
        });
        
        // Quick filter buttons
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterName = this.dataset.filter;
                const filterValue = this.dataset.value;
                
                this.classList.toggle('active');
                
                const formField = document.getElementById(filterName);
                if (formField) {
                    if (this.classList.contains('active')) {
                        // For categories, we need to find the matching category ID
                        if (filterName === 'category') {
                            const categorySelect = document.getElementById('category');
                            const categoryOptions = categorySelect.options;
                            let foundCategoryId = null;
                            
                            // Look for a category that matches our value
                            for (let i = 0; i < categoryOptions.length; i++) {
                                const option = categoryOptions[i];
                                const optionText = option.text.toLowerCase();
                                const searchValue = filterValue.toLowerCase();
                                
                                if (optionText.includes(searchValue) || 
                                    searchValue.includes(optionText) ||
                                    optionText.includes('hotline') && searchValue.includes('hotline') ||
                                    optionText.includes('housing') && searchValue.includes('housing') ||
                                    optionText.includes('medical') && searchValue.includes('medical') ||
                                    optionText.includes('mental') && searchValue.includes('mental') ||
                                    optionText.includes('food') && searchValue.includes('food') ||
                                    optionText.includes('emergency') && searchValue.includes('emergency') ||
                                    optionText.includes('legal') && searchValue.includes('legal') ||
                                    optionText.includes('transportation') && searchValue.includes('transportation')) {
                                    foundCategoryId = option.value;
                                    break;
                                }
                            }
                            
                            if (foundCategoryId) {
                                formField.value = foundCategoryId;
                            }
                        } else {
                            formField.value = filterValue;
                        }
                    } else {
                        formField.value = '';
                    }
                }
                
                updateActiveFilters();
                filterForm.submit();
            });
        });
        
        // Auto-submit on filter changes
        let submitTimeout;
        const filterInputs = document.querySelectorAll('#category, #service_type, #sort');
        const hour24Input = document.getElementById('24hour');
        
        // Add event listeners to all filter inputs
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                clearTimeout(submitTimeout);
                submitTimeout = setTimeout(() => {
                    updateActiveFilters();
                    filterForm.submit();
                }, 300);
            });
        });
        
        // Add event listener to 24hour input separately (since it has a number in the ID)
        if (hour24Input) {
            hour24Input.addEventListener('change', function() {
                clearTimeout(submitTimeout);
                submitTimeout = setTimeout(() => {
                    updateActiveFilters();
                    filterForm.submit();
                }, 300);
            });
        }
        
        // Update active filters display
        function updateActiveFilters() {
            activeFilters.innerHTML = '';
            let hasActiveFilters = false;
            
            const formData = new FormData(filterForm);
            for (let [key, value] of formData.entries()) {
                if (value && key !== 'q' && key !== 'page') {
                    hasActiveFilters = true;
                    const filterTag = createFilterTag(key, value);
                    activeFilters.appendChild(filterTag);
                }
            }
            
            activeFiltersContainer.style.display = hasActiveFilters ? 'block' : 'none';
        }
        
        // Create filter tag element
        function createFilterTag(filterName, filterValue) {
            const tag = document.createElement('span');
            tag.className = 'active-filter-tag';
            
            const displayName = getFilterDisplayName(filterName, filterValue);
            
            tag.innerHTML = `
                <span>${displayName}</span>
                <button type="button" class="remove-filter" data-filter="${filterName}" data-value="${filterValue}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            tag.querySelector('.remove-filter').addEventListener('click', function() {
                const filterField = document.getElementById(filterName);
                if (filterField) {
                    filterField.value = '';
                }
                
                const quickBtn = document.querySelector(`[data-filter="${filterName}"][data-value="${filterValue}"]`);
                if (quickBtn) {
                    quickBtn.classList.remove('active');
                }
                
                updateActiveFilters();
                filterForm.submit();
            });
            
            return tag;
        }
        
        // Get display name for filter
        function getFilterDisplayName(filterName, filterValue) {
            const filterLabels = {
                'category': 'Category',
                'service_type': 'Service Type',
                'emergency': 'Emergency Services',
                '24hour': '24/7 Services',
                'city': 'City',
                'state': 'State',
                'sort': 'Sort'
            };
            
            const valueLabels = {
                'true': 'Yes',
                'false': 'No',
                'name': 'Name A-Z',
                'city': 'City A-Z',
                'category': 'Category',
                'emergency': 'Emergency First'
            };
            
            const label = filterLabels[filterName] || filterName;
            let value = valueLabels[filterValue] || filterValue;
            
            // For categories, try to get the actual category name
            if (filterName === 'category' && filterValue) {
                const categorySelect = document.getElementById('category');
                if (categorySelect) {
                    const categoryOptions = categorySelect.options;
                    for (let i = 0; i < categoryOptions.length; i++) {
                        const option = categoryOptions[i];
                        if (option.value === filterValue) {
                            value = option.text;
                            break;
                        }
                    }
                }
            }
            
            // For service types, try to get the actual service type name
            if (filterName === 'service_type' && filterValue) {
                const serviceTypeSelect = document.getElementById('service_type');
                if (serviceTypeSelect) {
                    const serviceTypeOptions = serviceTypeSelect.options;
                    for (let i = 0; i < serviceTypeOptions.length; i++) {
                        const option = serviceTypeOptions[i];
                        if (option.value === filterValue) {
                            value = option.text;
                            break;
                        }
                    }
                }
            }
            
            return `${label}: ${value}`;
        }
        
        // Initialize active filters
        updateActiveFilters();
        
        // Search with debounce
        const searchInput = document.getElementById('search');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length >= 3 || this.value.length === 0) {
                    filterForm.submit();
                }
            }, 500);
        });
    });
</script>
{% endblock %}
